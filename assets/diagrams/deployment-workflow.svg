<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1000">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#616161"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32"/>
    </marker>
    <marker id="arrow-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f57c00"/>
    </marker>
  </defs>

  <style>
    .title { fill: #212121; font-family: system-ui, sans-serif; font-size: 24px; font-weight: bold; }
    .subtitle { fill: #424242; font-family: system-ui, sans-serif; font-size: 14px; }
    .label { fill: white; font-family: system-ui, sans-serif; }
    .text-dark { fill: #212121; font-family: system-ui, sans-serif; }
    .text-medium { fill: #424242; font-family: system-ui, sans-serif; }
    .text-light { fill: #757575; font-family: system-ui, sans-serif; }
    .phase-box { fill: #4051b5; stroke: #303f9f; stroke-width: 2; }
    .pretask-box { fill: #7b1fa2; stroke: #4a148c; stroke-width: 2; }
    .role-box { fill: #1976d2; stroke: #0d47a1; stroke-width: 2; }
    .role-optional { fill: #00838f; stroke: #006064; stroke-width: 2; }
    .task-box { fill: #f57c00; stroke: #e65100; stroke-width: 2; }
    .posttask-box { fill: #388e3c; stroke: #1b5e20; stroke-width: 2; }
    .reboot-box { fill: #c62828; stroke: #b71c1c; stroke-width: 2; }
    .connector { stroke: #616161; stroke-width: 2; fill: none; }
    .connector-optional { stroke: #616161; stroke-width: 2; stroke-dasharray: 6,3; fill: none; }
  </style>

  <!-- Background -->
  <rect width="1200" height="1000" fill="#fafafa"/>

  <!-- Title -->
  <text x="600" y="40" text-anchor="middle" class="title">Ansible Deployment Workflow</text>
  <text x="600" y="65" text-anchor="middle" class="subtitle">deploy.yml: Complete node configuration sequence</text>

  <!-- Left Column: Pre-tasks -->
  <g transform="translate(80, 100)">
    <text x="100" y="0" text-anchor="middle" class="text-dark" font-size="16" font-weight="bold">Pre-Tasks</text>

    <!-- Start -->
    <ellipse cx="100" cy="40" rx="60" ry="20" fill="#4051b5" stroke="#303f9f" stroke-width="2"/>
    <text x="100" y="45" text-anchor="middle" class="label" font-size="12">ansible-playbook</text>

    <line x1="100" y1="60" x2="100" y2="85" class="connector" marker-end="url(#arrow)"/>

    <!-- Pre-task 1 -->
    <rect class="pretask-box" x="10" y="90" width="180" height="45" rx="6"/>
    <text x="100" y="110" text-anchor="middle" class="label" font-size="11" font-weight="bold">Start Repo Server</text>
    <text x="100" y="125" text-anchor="middle" fill="#e1bee7" font-size="9">python3 -m http.server 8080</text>

    <line x1="100" y1="135" x2="100" y2="150" class="connector" marker-end="url(#arrow)"/>

    <!-- Pre-task 2 -->
    <rect class="pretask-box" x="10" y="155" width="180" height="45" rx="6"/>
    <text x="100" y="175" text-anchor="middle" class="label" font-size="11" font-weight="bold">Wait for SSH</text>
    <text x="100" y="190" text-anchor="middle" fill="#e1bee7" font-size="9">retries: 30, delay: 10s</text>

    <line x1="100" y1="200" x2="100" y2="215" class="connector" marker-end="url(#arrow)"/>

    <!-- Pre-task 3 -->
    <rect class="pretask-box" x="10" y="220" width="180" height="45" rx="6"/>
    <text x="100" y="240" text-anchor="middle" class="label" font-size="11" font-weight="bold">Test Connection</text>
    <text x="100" y="255" text-anchor="middle" fill="#e1bee7" font-size="9">uname -a, gather facts</text>

    <line x1="100" y1="265" x2="100" y2="280" class="connector" marker-end="url(#arrow)"/>

    <!-- Pre-task 4 -->
    <rect class="pretask-box" x="10" y="285" width="180" height="45" rx="6"/>
    <text x="100" y="305" text-anchor="middle" class="label" font-size="11" font-weight="bold">Load Environment</text>
    <text x="100" y="320" text-anchor="middle" fill="#e1bee7" font-size="9">load_env_vars.yml</text>

    <!-- Arrow to Roles -->
    <path d="M190,307 L220,307 L220,400 L280,400" class="connector" marker-end="url(#arrow)"/>
  </g>

  <!-- Center Column: Roles -->
  <g transform="translate(360, 100)">
    <text x="150" y="0" text-anchor="middle" class="text-dark" font-size="16" font-weight="bold">Configuration Roles</text>

    <!-- Role 1: Backup -->
    <rect class="role-box" x="10" y="25" width="140" height="40" rx="6"/>
    <text x="80" y="42" text-anchor="middle" class="label" font-size="11" font-weight="bold">backup</text>
    <text x="80" y="56" text-anchor="middle" fill="#bbdefb" font-size="9">Save existing config</text>

    <line x1="80" y1="65" x2="80" y2="75" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 2: Package Management -->
    <rect class="role-box" x="10" y="80" width="140" height="40" rx="6"/>
    <text x="80" y="97" text-anchor="middle" class="label" font-size="11" font-weight="bold">package_mgmt</text>
    <text x="80" y="111" text-anchor="middle" fill="#bbdefb" font-size="9">opkg install batman-adv</text>

    <line x1="80" y1="120" x2="80" y2="130" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 3: SSH Transition -->
    <rect class="role-box" x="10" y="135" width="140" height="40" rx="6"/>
    <text x="80" y="152" text-anchor="middle" class="label" font-size="11" font-weight="bold">ssh_transition</text>
    <text x="80" y="166" text-anchor="middle" fill="#bbdefb" font-size="9">dropbear → openssh</text>

    <line x1="80" y1="175" x2="80" y2="185" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 4: System Config -->
    <rect class="role-box" x="10" y="190" width="140" height="40" rx="6"/>
    <text x="80" y="207" text-anchor="middle" class="label" font-size="11" font-weight="bold">system_config</text>
    <text x="80" y="221" text-anchor="middle" fill="#bbdefb" font-size="9">hostname, timezone, root</text>

    <line x1="80" y1="230" x2="80" y2="240" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 5: Network Config -->
    <rect class="role-box" x="10" y="245" width="140" height="40" rx="6"/>
    <text x="80" y="262" text-anchor="middle" class="label" font-size="11" font-weight="bold">network_config</text>
    <text x="80" y="276" text-anchor="middle" fill="#bbdefb" font-size="9">VLANs, batman-adv, IPs</text>

    <line x1="80" y1="285" x2="80" y2="295" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 6: Wireless Config -->
    <rect class="role-box" x="10" y="300" width="140" height="40" rx="6"/>
    <text x="80" y="317" text-anchor="middle" class="label" font-size="11" font-weight="bold">wireless_config</text>
    <text x="80" y="331" text-anchor="middle" fill="#bbdefb" font-size="9">mesh, AP, WPA3</text>

    <line x1="80" y1="340" x2="80" y2="350" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 7: DHCP Config -->
    <rect class="role-box" x="10" y="355" width="140" height="40" rx="6"/>
    <text x="80" y="372" text-anchor="middle" class="label" font-size="11" font-weight="bold">dhcp_config</text>
    <text x="80" y="386" text-anchor="middle" fill="#bbdefb" font-size="9">Per-node DHCP pools</text>

    <line x1="80" y1="395" x2="80" y2="405" class="connector" marker-end="url(#arrow)"/>

    <!-- Role 8: Firewall Config -->
    <rect class="role-box" x="10" y="410" width="140" height="40" rx="6"/>
    <text x="80" y="427" text-anchor="middle" class="label" font-size="11" font-weight="bold">firewall_config</text>
    <text x="80" y="441" text-anchor="middle" fill="#bbdefb" font-size="9">zones, rules, NAT</text>

    <!-- Optional Roles Column -->
    <g transform="translate(160, 0)">
      <text x="80" y="0" text-anchor="middle" class="text-medium" font-size="13" font-style="italic">Optional</text>

      <!-- Conditional arrow -->
      <path d="M-50,450 L-50,480 L0,480" class="connector-optional" marker-end="url(#arrow)"/>

      <!-- Role 9: USB Storage -->
      <rect class="role-optional" x="10" y="460" width="140" height="40" rx="6"/>
      <text x="80" y="477" text-anchor="middle" class="label" font-size="11" font-weight="bold">usb_storage</text>
      <text x="80" y="491" text-anchor="middle" fill="#b2ebf2" font-size="9">F2FS on /x00</text>

      <line x1="80" y1="500" x2="80" y2="510" class="connector-optional" marker-end="url(#arrow)"/>

      <!-- Role 10: Monitoring -->
      <rect class="role-optional" x="10" y="515" width="140" height="40" rx="6"/>
      <text x="80" y="532" text-anchor="middle" class="label" font-size="11" font-weight="bold">monitoring</text>
      <text x="80" y="546" text-anchor="middle" fill="#b2ebf2" font-size="9">collectd, vnstat</text>

      <!-- Condition note -->
      <text x="80" y="575" text-anchor="middle" class="text-light" font-size="9">if USB detected &amp;</text>
      <text x="80" y="587" text-anchor="middle" class="text-light" font-size="9">ENABLE_* = true</text>
    </g>

    <!-- Arrow to Tasks -->
    <path d="M150,450 L200,450 L200,650 L260,650" class="connector" marker-end="url(#arrow)"/>
  </g>

  <!-- Right Column: Post-deploy Tasks -->
  <g transform="translate(700, 100)">
    <text x="120" y="0" text-anchor="middle" class="text-dark" font-size="16" font-weight="bold">Post-Deploy Tasks</text>

    <!-- Task 1: Display Status -->
    <rect class="task-box" x="10" y="25" width="220" height="50" rx="6"/>
    <text x="120" y="45" text-anchor="middle" class="label" font-size="11" font-weight="bold">Display Configuration Status</text>
    <text x="120" y="62" text-anchor="middle" fill="#ffe0b2" font-size="9">Show deployed configs and next steps</text>

    <line x1="120" y1="75" x2="120" y2="90" class="connector" marker-end="url(#arrow)"/>

    <!-- Task 2: Restore opkg -->
    <rect class="task-box" x="10" y="95" width="220" height="50" rx="6"/>
    <text x="120" y="115" text-anchor="middle" class="label" font-size="11" font-weight="bold">Restore opkg Configuration</text>
    <text x="120" y="132" text-anchor="middle" fill="#ffe0b2" font-size="9">Restore official OpenWrt repos</text>

    <line x1="120" y1="145" x2="120" y2="160" class="connector" marker-end="url(#arrow)"/>

    <!-- Task 3: Deploy bat-hosts -->
    <rect class="task-box" x="10" y="165" width="220" height="50" rx="6"/>
    <text x="120" y="185" text-anchor="middle" class="label" font-size="11" font-weight="bold">Deploy bat-hosts File</text>
    <text x="120" y="202" text-anchor="middle" fill="#ffe0b2" font-size="9">Batman-adv MAC→hostname mapping</text>

    <line x1="120" y1="215" x2="120" y2="230" class="connector" marker-end="url(#arrow)"/>

    <!-- Task 4: Pre-reboot Warning -->
    <rect class="task-box" x="10" y="235" width="220" height="50" rx="6"/>
    <text x="120" y="255" text-anchor="middle" class="label" font-size="11" font-weight="bold">Pre-reboot Warning</text>
    <text x="120" y="272" text-anchor="middle" fill="#ffe0b2" font-size="9">IP will change: 192.168.1.1 → 10.11.12.x</text>

    <line x1="120" y1="285" x2="120" y2="300" class="connector" marker-end="url(#arrow)"/>

    <!-- Task 5: REBOOT -->
    <rect class="reboot-box" x="10" y="305" width="220" height="55" rx="6"/>
    <text x="120" y="328" text-anchor="middle" class="label" font-size="13" font-weight="bold">REBOOT NODE</text>
    <text x="120" y="348" text-anchor="middle" fill="#ffcdd2" font-size="10">Applies all configurations</text>

    <line x1="120" y1="360" x2="120" y2="375" class="connector" marker-end="url(#arrow)"/>

    <!-- Task 6: Post-reboot Instructions -->
    <rect class="task-box" x="10" y="380" width="220" height="50" rx="6"/>
    <text x="120" y="400" text-anchor="middle" class="label" font-size="11" font-weight="bold">Post-reboot Instructions</text>
    <text x="120" y="417" text-anchor="middle" fill="#ffe0b2" font-size="9">Change network, verify, SSH</text>

    <line x1="120" y1="430" x2="120" y2="445" class="connector" marker-end="url(#arrow)"/>

    <!-- Post-task: Stop repo server -->
    <rect class="posttask-box" x="10" y="450" width="220" height="50" rx="6"/>
    <text x="120" y="470" text-anchor="middle" class="label" font-size="11" font-weight="bold">Stop Repo Server</text>
    <text x="120" y="487" text-anchor="middle" fill="#c8e6c9" font-size="9">Cleanup: kill python3 http.server</text>

    <line x1="120" y1="500" x2="120" y2="515" class="connector" marker-end="url(#arrow)"/>

    <!-- End -->
    <ellipse cx="120" cy="535" rx="60" ry="20" fill="#388e3c" stroke="#1b5e20" stroke-width="2"/>
    <text x="120" y="540" text-anchor="middle" class="label" font-size="12">Complete</text>
  </g>

  <!-- Bottom Section: Deployment Commands -->
  <g transform="translate(40, 740)">
    <rect width="1120" height="100" rx="8" fill="#f5f5f5" stroke="#e0e0e0" stroke-width="1"/>
    <text x="560" y="25" text-anchor="middle" class="text-dark" font-size="14" font-weight="bold">Deployment Commands</text>

    <!-- Initial Setup -->
    <g transform="translate(30, 35)">
      <rect width="340" height="55" rx="4" fill="#fff3e0" stroke="#f57c00" stroke-width="1"/>
      <text x="170" y="18" text-anchor="middle" class="text-dark" font-size="11" font-weight="bold">Initial Setup (Fresh Node @ 192.168.1.1)</text>
      <text x="10" y="38" class="text-medium" font-size="9" font-family="monospace">ansible-playbook -i inventory/hosts-initial.yml \</text>
      <text x="10" y="50" class="text-medium" font-size="9" font-family="monospace">  playbooks/deploy.yml --limit node1</text>
    </g>

    <!-- Production -->
    <g transform="translate(390, 35)">
      <rect width="340" height="55" rx="4" fill="#e8f5e9" stroke="#388e3c" stroke-width="1"/>
      <text x="170" y="18" text-anchor="middle" class="text-dark" font-size="11" font-weight="bold">Production (Configured @ 10.11.12.x)</text>
      <text x="10" y="38" class="text-medium" font-size="9" font-family="monospace">ansible-playbook -i inventory/hosts.yml \</text>
      <text x="10" y="50" class="text-medium" font-size="9" font-family="monospace">  playbooks/deploy.yml</text>
    </g>

    <!-- Check Mode -->
    <g transform="translate(750, 35)">
      <rect width="340" height="55" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1"/>
      <text x="170" y="18" text-anchor="middle" class="text-dark" font-size="11" font-weight="bold">Dry Run (No Changes)</text>
      <text x="10" y="38" class="text-medium" font-size="9" font-family="monospace">ansible-playbook -i inventory/hosts.yml \</text>
      <text x="10" y="50" class="text-medium" font-size="9" font-family="monospace">  playbooks/deploy.yml --check</text>
    </g>
  </g>

  <!-- Legend -->
  <g transform="translate(40, 860)">
    <rect width="1120" height="120" rx="8" fill="#f5f5f5" stroke="#e0e0e0" stroke-width="1"/>
    <text x="560" y="25" text-anchor="middle" class="text-dark" font-size="14" font-weight="bold">Legend</text>

    <!-- Row 1 -->
    <rect x="50" y="40" width="20" height="15" rx="3" fill="#7b1fa2"/>
    <text x="80" y="52" class="text-dark" font-size="11">Pre-Tasks (Setup)</text>

    <rect x="220" y="40" width="20" height="15" rx="3" fill="#1976d2"/>
    <text x="250" y="52" class="text-dark" font-size="11">Required Roles</text>

    <rect x="390" y="40" width="20" height="15" rx="3" fill="#00838f"/>
    <text x="420" y="52" class="text-dark" font-size="11">Optional Roles</text>

    <rect x="560" y="40" width="20" height="15" rx="3" fill="#f57c00"/>
    <text x="590" y="52" class="text-dark" font-size="11">Deploy Tasks</text>

    <rect x="730" y="40" width="20" height="15" rx="3" fill="#c62828"/>
    <text x="760" y="52" class="text-dark" font-size="11">Reboot (Critical)</text>

    <rect x="900" y="40" width="20" height="15" rx="3" fill="#388e3c"/>
    <text x="930" y="52" class="text-dark" font-size="11">Post-Tasks (Cleanup)</text>

    <!-- Row 2: Key Notes -->
    <text x="50" y="80" class="text-medium" font-size="10" font-weight="bold">Key Notes:</text>
    <text x="50" y="95" class="text-medium" font-size="10">• Config files deployed but NOT applied until reboot (prevents connection loss)</text>
    <text x="50" y="110" class="text-medium" font-size="10">• USB storage &amp; monitoring require detected USB device and ENABLE_* env vars</text>
    <text x="600" y="95" class="text-medium" font-size="10">• Initial setup: 192.168.1.1 → 10.11.12.x IP change requires network reconfiguration</text>
    <text x="600" y="110" class="text-medium" font-size="10">• Sequential deployment recommended for initial setup (one node at a time)</text>
  </g>
</svg>
