<!DOCTYPE html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="High-availability OpenWrt mesh network with Batman-adv routing"><meta name="author" content="OpenWrt Mesh Network Project"><link href="https://git-kubik.github.io/mesh/reference/factory-reset/" rel="canonical"><link href="../node-audit/" rel="prev"><link href="../../advanced/" rel="next"><link rel="icon" href="../../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Factory Reset - OpenWrt Mesh Network Documentation</title><link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css"><link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel="stylesheet" href="../../css/timeago.css"><link rel="stylesheet" href="../../stylesheets/extra.css"><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#why-openwrt-retains-root-password-after-factory-reset" class="md-skip"> Skip to content </a> </div> <div data-md-component="announce"> </div> <div data-md-color-scheme="default" data-md-component="outdated" hidden> </div> <header class="md-header" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="Header"> <a href="../.." title="OpenWrt Mesh Network Documentation" class="md-header__button md-logo" aria-label="OpenWrt Mesh Network Documentation" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> OpenWrt Mesh Network Documentation </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Factory Reset </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0"> <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required> <label class="md-search__icon md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class="md-search__options" aria-label="Search"> <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text data-md-component="search-share" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a href="https://github.com/git-kubik/mesh" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> git-kubik/mesh </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <nav class="md-tabs" aria-label="Tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a href="../.." class="md-tabs__link"> Home </a> </li> <li class="md-tabs__item"> <a href="../../getting-started/" class="md-tabs__link"> Getting Started </a> </li> <li class="md-tabs__item"> <a href="../../architecture/" class="md-tabs__link"> Architecture </a> </li> <li class="md-tabs__item"> <a href="../../deployment/" class="md-tabs__link"> Deployment </a> </li> <li class="md-tabs__item"> <a href="../../operations/" class="md-tabs__link"> Operations </a> </li> <li class="md-tabs__item"> <a href="../../development/" class="md-tabs__link"> Development </a> </li> <li class="md-tabs__item"> <a href="../../troubleshooting/" class="md-tabs__link"> Troubleshooting </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href="../" class="md-tabs__link"> Reference </a> </li> <li class="md-tabs__item"> <a href="../../advanced/" class="md-tabs__link"> Advanced </a> </li> </ul> </div> </nav> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href="../.." title="OpenWrt Mesh Network Documentation" class="md-nav__button md-logo" aria-label="OpenWrt Mesh Network Documentation" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> OpenWrt Mesh Network Documentation </label> <div class="md-nav__source"> <a href="https://github.com/git-kubik/mesh" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> git-kubik/mesh </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1"> <div class="md-nav__link md-nav__container"> <a href="../.." class="md-nav__link "> <span class="md-ellipsis"> Home </span> </a> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_1"> <span class="md-nav__icon md-icon"></span> Home </label> <ul class="md-nav__list" data-md-scrollfix> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2"> <div class="md-nav__link md-nav__container"> <a href="../../getting-started/" class="md-nav__link "> <span class="md-ellipsis"> Getting Started </span> </a> <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../getting-started/quickstart/" class="md-nav__link"> <span class="md-ellipsis"> Quick Start </span> </a> </li> <li class="md-nav__item"> <a href="../../getting-started/initial-setup/" class="md-nav__link"> <span class="md-ellipsis"> Initial Setup </span> </a> </li> <li class="md-nav__item"> <a href="../../getting-started/ansible-basics/" class="md-nav__link"> <span class="md-ellipsis"> Ansible Basics </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3"> <div class="md-nav__link md-nav__container"> <a href="../../architecture/" class="md-nav__link "> <span class="md-ellipsis"> Architecture </span> </a> <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../architecture/overview/" class="md-nav__link"> <span class="md-ellipsis"> Overview </span> </a> </li> <li class="md-nav__item"> <a href="../../architecture/batman-mesh/" class="md-nav__link"> <span class="md-ellipsis"> Batman-adv Protocol </span> </a> </li> <li class="md-nav__item"> <a href="../../architecture/network-topology/" class="md-nav__link"> <span class="md-ellipsis"> Network Topology </span> </a> </li> <li class="md-nav__item"> <a href="../../architecture/vlan-architecture/" class="md-nav__link"> <span class="md-ellipsis"> VLAN Architecture </span> </a> </li> <li class="md-nav__item"> <a href="../../architecture/switch-integration/" class="md-nav__link"> <span class="md-ellipsis"> Switch Integration </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4"> <div class="md-nav__link md-nav__container"> <a href="../../deployment/" class="md-nav__link "> <span class="md-ellipsis"> Deployment </span> </a> <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> Deployment </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../deployment/configuration/" class="md-nav__link"> <span class="md-ellipsis"> Configuration </span> </a> </li> <li class="md-nav__item"> <a href="../../deployment/ssh-keys/" class="md-nav__link"> <span class="md-ellipsis"> SSH Keys </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5"> <div class="md-nav__link md-nav__container"> <a href="../../operations/" class="md-nav__link "> <span class="md-ellipsis"> Operations </span> </a> <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_5"> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../operations/backup-restore/" class="md-nav__link"> <span class="md-ellipsis"> Backup &amp; Restore </span> </a> </li> <li class="md-nav__item"> <a href="../../operations/firmware/" class="md-nav__link"> <span class="md-ellipsis"> Firmware Management </span> </a> </li> <li class="md-nav__item"> <a href="../../operations/usb-storage/" class="md-nav__link"> <span class="md-ellipsis"> USB Storage </span> </a> </li> <li class="md-nav__item"> <a href="../../operations/monitoring/" class="md-nav__link"> <span class="md-ellipsis"> Monitoring </span> </a> </li> <li class="md-nav__item"> <a href="../../operations/syslog/" class="md-nav__link"> <span class="md-ellipsis"> Distributed Syslog </span> </a> </li> <li class="md-nav__item"> <a href="../../operations/recovery/" class="md-nav__link"> <span class="md-ellipsis"> Recovery </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6"> <div class="md-nav__link md-nav__container"> <a href="../../development/" class="md-nav__link "> <span class="md-ellipsis"> Development </span> </a> <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_6"> <span class="md-nav__icon md-icon"></span> Development </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../development/testing/" class="md-nav__link"> <span class="md-ellipsis"> Testing Guide </span> </a> </li> <li class="md-nav__item"> <a href="../../development/contributing/" class="md-nav__link"> <span class="md-ellipsis"> Contributing </span> </a> </li> <li class="md-nav__item"> <a href="../../development/pre-commit/" class="md-nav__link"> <span class="md-ellipsis"> Pre-commit Hooks </span> </a> </li> <li class="md-nav__item"> <a href="../../development/docker/" class="md-nav__link"> <span class="md-ellipsis"> Docker Setup </span> </a> </li> <li class="md-nav__item"> <a href="../../development/docker-mcp/" class="md-nav__link"> <span class="md-ellipsis"> Docker MCP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7"> <div class="md-nav__link md-nav__container"> <a href="../../troubleshooting/" class="md-nav__link "> <span class="md-ellipsis"> Troubleshooting </span> </a> <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_7"> <span class="md-nav__icon md-icon"></span> Troubleshooting </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../troubleshooting/common-issues/" class="md-nav__link"> <span class="md-ellipsis"> Common Issues </span> </a> </li> <li class="md-nav__item"> <a href="../../troubleshooting/debugging/" class="md-nav__link"> <span class="md-ellipsis"> Debugging Guide </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked> <div class="md-nav__link md-nav__container"> <a href="../" class="md-nav__link "> <span class="md-ellipsis"> Reference </span> </a> <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_8"> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../makefile/" class="md-nav__link"> <span class="md-ellipsis"> Makefile Commands </span> </a> </li> <li class="md-nav__item"> <a href="../playbooks/" class="md-nav__link"> <span class="md-ellipsis"> Playbooks </span> </a> </li> <li class="md-nav__item"> <a href="../cli-commands/" class="md-nav__link"> <span class="md-ellipsis"> CLI Commands </span> </a> </li> <li class="md-nav__item"> <a href="../node-audit/" class="md-nav__link"> <span class="md-ellipsis"> Node Audit </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc"> <label class="md-nav__link md-nav__link--active" for="__toc"> <span class="md-ellipsis"> Factory Reset </span> <span class="md-nav__icon md-icon"></span> </label> <a href="./" class="md-nav__link md-nav__link--active"> <span class="md-ellipsis"> Factory Reset </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#research-summary" class="md-nav__link"> <span class="md-ellipsis"> Research Summary </span> </a> </li> <li class="md-nav__item"> <a href="#quick-answer" class="md-nav__link"> <span class="md-ellipsis"> Quick Answer </span> </a> </li> <li class="md-nav__item"> <a href="#openwrt-filesystem-architecture" class="md-nav__link"> <span class="md-ellipsis"> OpenWrt Filesystem Architecture </span> </a> <nav class="md-nav" aria-label="OpenWrt Filesystem Architecture"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#key-components" class="md-nav__link"> <span class="md-ellipsis"> Key Components </span> </a> </li> <li class="md-nav__item"> <a href="#how-file-lookups-work" class="md-nav__link"> <span class="md-ellipsis"> How File Lookups Work </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#password-storage-mechanism" class="md-nav__link"> <span class="md-ellipsis"> Password Storage Mechanism </span> </a> <nav class="md-nav" aria-label="Password Storage Mechanism"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#default-factory-password-no-password-set" class="md-nav__link"> <span class="md-ellipsis"> Default Factory Password (No Password Set) </span> </a> </li> <li class="md-nav__item"> <a href="#after-deployment-password-set" class="md-nav__link"> <span class="md-ellipsis"> After Deployment (Password Set) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#types-of-factory-resets-and-their-behavior" class="md-nav__link"> <span class="md-ellipsis"> Types of Factory Resets and Their Behavior </span> </a> <nav class="md-nav" aria-label="Types of Factory Resets and Their Behavior"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#1-firstboot-reset-safest" class="md-nav__link"> <span class="md-ellipsis"> 1. Firstboot Reset (Safest) </span> </a> </li> <li class="md-nav__item"> <a href="#2-firmware-flash-with-sysupgrade-default" class="md-nav__link"> <span class="md-ellipsis"> 2. Firmware Flash with sysupgrade (Default) </span> </a> </li> <li class="md-nav__item"> <a href="#3-firmware-flash-with-configuration-backup" class="md-nav__link"> <span class="md-ellipsis"> 3. Firmware Flash with Configuration Backup </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#why-password-persists-in-our-mesh-network" class="md-nav__link"> <span class="md-ellipsis"> Why Password Persists in Our Mesh Network </span> </a> <nav class="md-nav" aria-label="Why Password Persists in Our Mesh Network"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#scenario-where-password-persists-after-reset" class="md-nav__link"> <span class="md-ellipsis"> Scenario Where Password Persists After Reset </span> </a> </li> <li class="md-nav__item"> <a href="#the-d-link-dir-1960-a1-specific-behavior" class="md-nav__link"> <span class="md-ellipsis"> The D-Link DIR-1960 A1 Specific Behavior </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#how-sysupgrade-backup-works" class="md-nav__link"> <span class="md-ellipsis"> How sysupgrade Backup Works </span> </a> <nav class="md-nav" aria-label="How sysupgrade Backup Works"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#the-sysupgrade-b-backup-command" class="md-nav__link"> <span class="md-ellipsis"> The sysupgrade -b (Backup) Command </span> </a> </li> <li class="md-nav__item"> <a href="#the-sysupgrade-r-restore-command" class="md-nav__link"> <span class="md-ellipsis"> The sysupgrade -r (Restore) Command </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#complete-scenario-why-password-persisted" class="md-nav__link"> <span class="md-ellipsis"> Complete Scenario: Why Password Persisted </span> </a> <nav class="md-nav" aria-label="Complete Scenario: Why Password Persisted"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#timeline" class="md-nav__link"> <span class="md-ellipsis"> Timeline </span> </a> </li> <li class="md-nav__item"> <a href="#why-d-link-dir-1960-a1-preserves-password" class="md-nav__link"> <span class="md-ellipsis"> Why D-Link DIR-1960 A1 Preserves Password </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#complete-vs-partial-factory-resets" class="md-nav__link"> <span class="md-ellipsis"> Complete vs Partial Factory Resets </span> </a> <nav class="md-nav" aria-label="Complete vs Partial Factory Resets"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#complete-factory-reset-wipes-everything" class="md-nav__link"> <span class="md-ellipsis"> Complete Factory Reset (Wipes Everything) </span> </a> </li> <li class="md-nav__item"> <a href="#partialselective-factory-reset-sysupgrade-n" class="md-nav__link"> <span class="md-ellipsis"> Partial/Selective Factory Reset (sysupgrade -n) </span> </a> </li> <li class="md-nav__item"> <a href="#backup-assisted-reset-most-likely-scenario-in-our-case" class="md-nav__link"> <span class="md-ellipsis"> Backup-Assisted Reset (Most Likely Scenario in Our Case) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#our-deployments-role" class="md-nav__link"> <span class="md-ellipsis"> Our Deployment's Role </span> </a> <nav class="md-nav" aria-label="Our Deployment's Role"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#what-our-playbook-does" class="md-nav__link"> <span class="md-ellipsis"> What Our Playbook Does </span> </a> </li> <li class="md-nav__item"> <a href="#how-this-leads-to-password-persistence" class="md-nav__link"> <span class="md-ellipsis"> How This Leads to Password Persistence </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#file-persistence-matrix" class="md-nav__link"> <span class="md-ellipsis"> File Persistence Matrix </span> </a> </li> <li class="md-nav__item"> <a href="#technical-deep-dive-openwrt-boot-process" class="md-nav__link"> <span class="md-ellipsis"> Technical Deep Dive: OpenWrt Boot Process </span> </a> <nav class="md-nav" aria-label="Technical Deep Dive: OpenWrt Boot Process"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#boot-sequence" class="md-nav__link"> <span class="md-ellipsis"> Boot Sequence </span> </a> </li> <li class="md-nav__item"> <a href="#union-mount-priority" class="md-nav__link"> <span class="md-ellipsis"> Union Mount Priority </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#prevention-ensuring-clean-factory-reset" class="md-nav__link"> <span class="md-ellipsis"> Prevention: Ensuring Clean Factory Reset </span> </a> <nav class="md-nav" aria-label="Prevention: Ensuring Clean Factory Reset"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#method-1-complete-overlay-erase-most-secure" class="md-nav__link"> <span class="md-ellipsis"> Method 1: Complete Overlay Erase (Most Secure) </span> </a> </li> <li class="md-nav__item"> <a href="#method-2-factory-reset-button" class="md-nav__link"> <span class="md-ellipsis"> Method 2: Factory Reset Button </span> </a> </li> <li class="md-nav__item"> <a href="#method-3-secure-firmware-flash" class="md-nav__link"> <span class="md-ellipsis"> Method 3: Secure Firmware Flash </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#our-deployment-improvements" class="md-nav__link"> <span class="md-ellipsis"> Our Deployment Improvements </span> </a> <nav class="md-nav" aria-label="Our Deployment Improvements"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#current-behavior-what-happens-now" class="md-nav__link"> <span class="md-ellipsis"> Current Behavior (What Happens Now) </span> </a> </li> <li class="md-nav__item"> <a href="#recommended-improvements" class="md-nav__link"> <span class="md-ellipsis"> Recommended Improvements </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#conclusion" class="md-nav__link"> <span class="md-ellipsis"> Conclusion </span> </a> </li> <li class="md-nav__item"> <a href="#references" class="md-nav__link"> <span class="md-ellipsis"> References </span> </a> <nav class="md-nav" aria-label="References"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#openwrt-documentation" class="md-nav__link"> <span class="md-ellipsis"> OpenWrt Documentation </span> </a> </li> <li class="md-nav__item"> <a href="#our-codebase" class="md-nav__link"> <span class="md-ellipsis"> Our Codebase </span> </a> </li> <li class="md-nav__item"> <a href="#technical-details" class="md-nav__link"> <span class="md-ellipsis"> Technical Details </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9"> <div class="md-nav__link md-nav__container"> <a href="../../advanced/" class="md-nav__link "> <span class="md-ellipsis"> Advanced </span> </a> <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_9"> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../advanced/image-builder/" class="md-nav__link"> <span class="md-ellipsis"> Image Builder </span> </a> </li> <li class="md-nav__item"> <a href="../../advanced/local-repository/" class="md-nav__link"> <span class="md-ellipsis"> Local Repository </span> </a> </li> <li class="md-nav__item"> <a href="../../advanced/repo-implementation/" class="md-nav__link"> <span class="md-ellipsis"> Repository Implementation </span> </a> </li> <li class="md-nav__item"> <a href="../../advanced/full-archive/" class="md-nav__link"> <span class="md-ellipsis"> Full Archive Mode </span> </a> </li> <li class="md-nav__item"> <a href="../../advanced/monitoring-alerting/" class="md-nav__link"> <span class="md-ellipsis"> Monitoring &amp; Alerting </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#research-summary" class="md-nav__link"> <span class="md-ellipsis"> Research Summary </span> </a> </li> <li class="md-nav__item"> <a href="#quick-answer" class="md-nav__link"> <span class="md-ellipsis"> Quick Answer </span> </a> </li> <li class="md-nav__item"> <a href="#openwrt-filesystem-architecture" class="md-nav__link"> <span class="md-ellipsis"> OpenWrt Filesystem Architecture </span> </a> <nav class="md-nav" aria-label="OpenWrt Filesystem Architecture"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#key-components" class="md-nav__link"> <span class="md-ellipsis"> Key Components </span> </a> </li> <li class="md-nav__item"> <a href="#how-file-lookups-work" class="md-nav__link"> <span class="md-ellipsis"> How File Lookups Work </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#password-storage-mechanism" class="md-nav__link"> <span class="md-ellipsis"> Password Storage Mechanism </span> </a> <nav class="md-nav" aria-label="Password Storage Mechanism"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#default-factory-password-no-password-set" class="md-nav__link"> <span class="md-ellipsis"> Default Factory Password (No Password Set) </span> </a> </li> <li class="md-nav__item"> <a href="#after-deployment-password-set" class="md-nav__link"> <span class="md-ellipsis"> After Deployment (Password Set) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#types-of-factory-resets-and-their-behavior" class="md-nav__link"> <span class="md-ellipsis"> Types of Factory Resets and Their Behavior </span> </a> <nav class="md-nav" aria-label="Types of Factory Resets and Their Behavior"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#1-firstboot-reset-safest" class="md-nav__link"> <span class="md-ellipsis"> 1. Firstboot Reset (Safest) </span> </a> </li> <li class="md-nav__item"> <a href="#2-firmware-flash-with-sysupgrade-default" class="md-nav__link"> <span class="md-ellipsis"> 2. Firmware Flash with sysupgrade (Default) </span> </a> </li> <li class="md-nav__item"> <a href="#3-firmware-flash-with-configuration-backup" class="md-nav__link"> <span class="md-ellipsis"> 3. Firmware Flash with Configuration Backup </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#why-password-persists-in-our-mesh-network" class="md-nav__link"> <span class="md-ellipsis"> Why Password Persists in Our Mesh Network </span> </a> <nav class="md-nav" aria-label="Why Password Persists in Our Mesh Network"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#scenario-where-password-persists-after-reset" class="md-nav__link"> <span class="md-ellipsis"> Scenario Where Password Persists After Reset </span> </a> </li> <li class="md-nav__item"> <a href="#the-d-link-dir-1960-a1-specific-behavior" class="md-nav__link"> <span class="md-ellipsis"> The D-Link DIR-1960 A1 Specific Behavior </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#how-sysupgrade-backup-works" class="md-nav__link"> <span class="md-ellipsis"> How sysupgrade Backup Works </span> </a> <nav class="md-nav" aria-label="How sysupgrade Backup Works"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#the-sysupgrade-b-backup-command" class="md-nav__link"> <span class="md-ellipsis"> The sysupgrade -b (Backup) Command </span> </a> </li> <li class="md-nav__item"> <a href="#the-sysupgrade-r-restore-command" class="md-nav__link"> <span class="md-ellipsis"> The sysupgrade -r (Restore) Command </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#complete-scenario-why-password-persisted" class="md-nav__link"> <span class="md-ellipsis"> Complete Scenario: Why Password Persisted </span> </a> <nav class="md-nav" aria-label="Complete Scenario: Why Password Persisted"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#timeline" class="md-nav__link"> <span class="md-ellipsis"> Timeline </span> </a> </li> <li class="md-nav__item"> <a href="#why-d-link-dir-1960-a1-preserves-password" class="md-nav__link"> <span class="md-ellipsis"> Why D-Link DIR-1960 A1 Preserves Password </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#complete-vs-partial-factory-resets" class="md-nav__link"> <span class="md-ellipsis"> Complete vs Partial Factory Resets </span> </a> <nav class="md-nav" aria-label="Complete vs Partial Factory Resets"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#complete-factory-reset-wipes-everything" class="md-nav__link"> <span class="md-ellipsis"> Complete Factory Reset (Wipes Everything) </span> </a> </li> <li class="md-nav__item"> <a href="#partialselective-factory-reset-sysupgrade-n" class="md-nav__link"> <span class="md-ellipsis"> Partial/Selective Factory Reset (sysupgrade -n) </span> </a> </li> <li class="md-nav__item"> <a href="#backup-assisted-reset-most-likely-scenario-in-our-case" class="md-nav__link"> <span class="md-ellipsis"> Backup-Assisted Reset (Most Likely Scenario in Our Case) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#our-deployments-role" class="md-nav__link"> <span class="md-ellipsis"> Our Deployment's Role </span> </a> <nav class="md-nav" aria-label="Our Deployment's Role"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#what-our-playbook-does" class="md-nav__link"> <span class="md-ellipsis"> What Our Playbook Does </span> </a> </li> <li class="md-nav__item"> <a href="#how-this-leads-to-password-persistence" class="md-nav__link"> <span class="md-ellipsis"> How This Leads to Password Persistence </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#file-persistence-matrix" class="md-nav__link"> <span class="md-ellipsis"> File Persistence Matrix </span> </a> </li> <li class="md-nav__item"> <a href="#technical-deep-dive-openwrt-boot-process" class="md-nav__link"> <span class="md-ellipsis"> Technical Deep Dive: OpenWrt Boot Process </span> </a> <nav class="md-nav" aria-label="Technical Deep Dive: OpenWrt Boot Process"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#boot-sequence" class="md-nav__link"> <span class="md-ellipsis"> Boot Sequence </span> </a> </li> <li class="md-nav__item"> <a href="#union-mount-priority" class="md-nav__link"> <span class="md-ellipsis"> Union Mount Priority </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#prevention-ensuring-clean-factory-reset" class="md-nav__link"> <span class="md-ellipsis"> Prevention: Ensuring Clean Factory Reset </span> </a> <nav class="md-nav" aria-label="Prevention: Ensuring Clean Factory Reset"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#method-1-complete-overlay-erase-most-secure" class="md-nav__link"> <span class="md-ellipsis"> Method 1: Complete Overlay Erase (Most Secure) </span> </a> </li> <li class="md-nav__item"> <a href="#method-2-factory-reset-button" class="md-nav__link"> <span class="md-ellipsis"> Method 2: Factory Reset Button </span> </a> </li> <li class="md-nav__item"> <a href="#method-3-secure-firmware-flash" class="md-nav__link"> <span class="md-ellipsis"> Method 3: Secure Firmware Flash </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#our-deployment-improvements" class="md-nav__link"> <span class="md-ellipsis"> Our Deployment Improvements </span> </a> <nav class="md-nav" aria-label="Our Deployment Improvements"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#current-behavior-what-happens-now" class="md-nav__link"> <span class="md-ellipsis"> Current Behavior (What Happens Now) </span> </a> </li> <li class="md-nav__item"> <a href="#recommended-improvements" class="md-nav__link"> <span class="md-ellipsis"> Recommended Improvements </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#conclusion" class="md-nav__link"> <span class="md-ellipsis"> Conclusion </span> </a> </li> <li class="md-nav__item"> <a href="#references" class="md-nav__link"> <span class="md-ellipsis"> References </span> </a> <nav class="md-nav" aria-label="References"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#openwrt-documentation" class="md-nav__link"> <span class="md-ellipsis"> OpenWrt Documentation </span> </a> </li> <li class="md-nav__item"> <a href="#our-codebase" class="md-nav__link"> <span class="md-ellipsis"> Our Codebase </span> </a> </li> <li class="md-nav__item"> <a href="#technical-details" class="md-nav__link"> <span class="md-ellipsis"> Technical Details </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <a href="https://github.com/git-kubik/mesh/edit/main/docs/reference/factory-reset.md" title="Edit this page" class="md-content__button md-icon" rel="edit"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"></path></svg> </a> <a href="https://github.com/git-kubik/mesh/raw/main/docs/reference/factory-reset.md" title="View source of this page" class="md-content__button md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"></path></svg> </a> <h1 id="why-openwrt-retains-root-password-after-factory-reset">Why OpenWrt Retains Root Password After Factory Reset<a class="headerlink" href="#why-openwrt-retains-root-password-after-factory-reset" title="Permanent link">¶</a></h1> <h2 id="research-summary">Research Summary<a class="headerlink" href="#research-summary" title="Permanent link">¶</a></h2> <p>This document explains the technical mechanisms behind why an OpenWrt D-Link DIR-1960 A1 router retained its root password after a factory reset, and how OpenWrt's sysupgrade backup system works.</p> <hr> <h2 id="quick-answer">Quick Answer<a class="headerlink" href="#quick-answer" title="Permanent link">¶</a></h2> <p><strong>The root password persists after factory reset because:</strong></p> <ol> <li><strong>OpenWrt uses a layered filesystem</strong> where configuration files in <code>/etc</code> are stored in the overlay partition (JFFS2)</li> <li><strong>The overlay partition may not be completely erased</strong> during all types of factory resets</li> <li><strong>The password hash is stored in <code>/etc/shadow</code></strong> which exists in the overlay layer</li> <li><strong>Different reset methods preserve different files</strong> - a simple factory reset may not wipe <code>/etc/shadow</code></li> <li><strong>Backup restore mechanisms</strong> can explicitly restore configuration files including password hashes</li> </ol> <hr> <h2 id="openwrt-filesystem-architecture">OpenWrt Filesystem Architecture<a class="headerlink" href="#openwrt-filesystem-architecture" title="Permanent link">¶</a></h2> <p>OpenWrt uses a <strong>layered union filesystem</strong> design:</p> <div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌─────────────────────────────────────────────────────────────┐
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│ /etc (Union Mount View)                                     │
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│ - Appears as single /etc directory to users                │
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>└─────────────────────────────────────────────────────────────┘
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>           ▲                        ▲
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>           │                        │
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    ┌──────┴──────────┐    ┌────────┴─────────┐
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    │                 │    │                  │
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  /rom/etc         /overlay/etc  
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  (Read-only)      (Writable)
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>  (Squashfs)       (JFFS2)
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>     └──────┬──────────┘       └────────┬──────────┘
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            │                           │
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>   ┌────────▼────────┐        ┌────────▼──────────┐
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>   │ Base System     │        │ Configuration     │
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>   │ (Factory)       │        │ (User Changes)    │
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>   │                 │        │                   │
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>   │ - passwd (root) │        │ - shadow (hash!)  │
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>   │ - group         │        │ - wifi config     │
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>   │ - default certs │        │ - network config  │
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>   └─────────────────┘        └───────────────────┘
</span></code></pre></div> <h3 id="key-components">Key Components<a class="headerlink" href="#key-components" title="Permanent link">¶</a></h3> <table> <thead> <tr> <th>Component</th> <th>Location</th> <th>Type</th> <th>Contents</th> </tr> </thead> <tbody> <tr> <td><strong>ROM</strong></td> <td><code>/rom</code></td> <td>Read-only (Squashfs)</td> <td>Base OpenWrt system, factory defaults</td> </tr> <tr> <td><strong>Overlay</strong></td> <td><code>/overlay</code></td> <td>Writable (JFFS2)</td> <td>Configuration changes, user modifications</td> </tr> <tr> <td><strong>Union Mount</strong></td> <td><code>/etc</code></td> <td>Virtual merge</td> <td>Combined view of ROM + Overlay</td> </tr> <tr> <td><strong>Root filesystem</strong></td> <td><code>/</code></td> <td>Squashfs overlay</td> <td>Everything combined</td> </tr> </tbody> </table> <h3 id="how-file-lookups-work">How File Lookups Work<a class="headerlink" href="#how-file-lookups-work" title="Permanent link">¶</a></h3> <p>When you read <code>/etc/shadow</code>:</p> <ol> <li>System checks <code>/overlay/etc/shadow</code> first (user layer)</li> <li>If not found, checks <code>/rom/etc/shadow</code> (factory default)</li> <li>If file exists in overlay, <strong>overlay version is used exclusively</strong></li> </ol> <p>This is crucial: <strong>once a file is customized in overlay, the ROM version is effectively hidden</strong>.</p> <hr> <h2 id="password-storage-mechanism">Password Storage Mechanism<a class="headerlink" href="#password-storage-mechanism" title="Permanent link">¶</a></h2> <h3 id="default-factory-password-no-password-set">Default Factory Password (No Password Set)<a class="headerlink" href="#default-factory-password-no-password-set" title="Permanent link">¶</a></h3> <p>Fresh OpenWrt routers start with:</p> <div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>/rom/etc/shadow:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>root::10933:0:99999:7:::
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>/etc/passwd:
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>root:*:0:0:root:/root:/bin/sh
</span></code></pre></div> <p><strong>Explanation:</strong></p> <ul> <li><code>:0:</code> in shadow means password hash is empty (no password)</li> <li>The <code>*</code> in passwd is a placeholder</li> <li>Dropbear SSH server allows login with NO password</li> </ul> <h3 id="after-deployment-password-set">After Deployment (Password Set)<a class="headerlink" href="#after-deployment-password-set" title="Permanent link">¶</a></h3> <p>Our Ansible playbook sets a password:</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">'password\npassword'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>passwd<span class="w"> </span>root
</span></code></pre></div> <p>This creates:</p> <div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>/overlay/etc/shadow:
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>root:$y$j9T$abcdef...:20000:0:99999:7:::
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>/etc/passwd (unchanged):
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>root:*:0:0:root:/root:/bin/sh
</span></code></pre></div> <p><strong>Key points:</strong></p> <ul> <li>Password hash is written to <code>/overlay/etc/shadow</code> (writable layer)</li> <li>The hash is Yescrypt-encrypted (modern OpenWrt uses <code>$y$</code>)</li> <li>The file permissions are strict: <code>600</code> (readable only by root)</li> </ul> <hr> <h2 id="types-of-factory-resets-and-their-behavior">Types of Factory Resets and Their Behavior<a class="headerlink" href="#types-of-factory-resets-and-their-behavior" title="Permanent link">¶</a></h2> <h3 id="1-firstboot-reset-safest">1. <strong>Firstboot Reset (Safest)</strong><a class="headerlink" href="#1-firstboot-reset-safest" title="Permanent link">¶</a></h3> <p><strong>Mechanism:</strong> Press reset button for 5-10 seconds, or via <code>mtd erase rootfs_data</code></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># This completely erases the overlay partition</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>mtd<span class="w"> </span>erase<span class="w"> </span>rootfs_data
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>reboot
</span></code></pre></div> <p><strong>Effect on files:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>✗ /overlay/etc/shadow  ← ERASED
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>✗ /overlay/etc/config  ← ERASED  
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>✓ /rom/etc/shadow      ← PRESERVED (factory default)
</span></code></pre></div> <p><strong>Result:</strong> Factory defaults restored, no password</p> <p><strong>Password survives?</strong> NO ❌</p> <hr> <h3 id="2-firmware-flash-with-sysupgrade-default">2. <strong>Firmware Flash with sysupgrade (Default)</strong><a class="headerlink" href="#2-firmware-flash-with-sysupgrade-default" title="Permanent link">¶</a></h3> <p><strong>Mechanism:</strong> <code>sysupgrade -n image.bin</code> (factory reset mode)</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>sysupgrade<span class="w"> </span>-n<span class="w"> </span>openwrt-24.10-squashfs-sysupgrade.bin
</span></code></pre></div> <p>The <code>-n</code> flag means "no backup" - don't preserve configuration</p> <p><strong>Effect on files:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>⚠️  /overlay/etc/shadow  ← DEPENDS on sysupgrade.conf
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>⚠️  /overlay/etc/config  ← DEPENDS on sysupgrade.conf
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>✓  /rom/* (new)         ← REFRESHED (new firmware)
</span></code></pre></div> <p><strong>Key issue:</strong> OpenWrt's <code>sysupgrade.conf</code> controls what gets preserved</p> <p><strong>D-Link DIR-1960 A1 sysupgrade.conf excerpt:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># /etc/sysupgrade.conf controls what survives firmware flash</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># These typically SURVIVE a sysupgrade:</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="nv">SAVE_CONFIG</span><span class="o">=</span><span class="m">1</span><span class="w">  </span><span class="c1"># Preserve /etc/config files</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="nv">SAVE_OVERLAY</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="c1"># Preserve /overlay contents</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="c1"># These do NOT survive with -n flag:</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="c1"># - Nothing if explicit preservation disabled</span>
</span></code></pre></div> <p><strong>Result:</strong> Depends on device and sysupgrade.conf settings</p> <p><strong>Password survives?</strong> MAYBE ⚠️ (Device dependent)</p> <hr> <h3 id="3-firmware-flash-with-configuration-backup">3. <strong>Firmware Flash with Configuration Backup</strong><a class="headerlink" href="#3-firmware-flash-with-configuration-backup" title="Permanent link">¶</a></h3> <p><strong>Mechanism:</strong> <code>sysupgrade -b backup.tar.gz</code> (create backup), then flash with restore</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Create backup BEFORE flash</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>sysupgrade<span class="w"> </span>-b<span class="w"> </span>backup-2025-11-13.tar.gz
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1"># Flash new firmware</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>sysupgrade<span class="w"> </span>openwrt-24.10-squashfs-sysupgrade.bin
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="c1"># AFTER reboot, restore from backup</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>sysupgrade<span class="w"> </span>-r<span class="w"> </span>/tmp/backup-2025-11-13.tar.gz
</span></code></pre></div> <p><strong>What's in the backup:</strong> (from our deploy.yml line 24-136)</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>sysupgrade<span class="w"> </span>-b<span class="w"> </span>/tmp/backup-<span class="o">{{</span><span class="w"> </span>node<span class="w"> </span><span class="o">}}</span>.tar.gz
</span></code></pre></div> <p>This backs up:</p> <ul> <li><code>/etc/config/*</code> - All configuration files</li> <li><code>/etc/ssh/*</code> - SSH keys and config</li> <li><code>/root/.ssh/*</code> - Authorized keys</li> <li><code>/etc/shadow</code> - Password hashes ⚠️⚠️⚠️</li> <li><code>/root/*</code> - Root home directory</li> </ul> <p><strong>Restore process:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>sysupgrade<span class="w"> </span>-r<span class="w"> </span>/tmp/backup-2025-11-13.tar.gz
</span></code></pre></div> <p>This OVERWRITES all files from the backup archive, including <code>/etc/shadow</code></p> <p><strong>Result:</strong> ALL configuration restored, including password</p> <p><strong>Password survives?</strong> YES ✅ (Explicitly restored)</p> <hr> <h2 id="why-password-persists-in-our-mesh-network">Why Password Persists in Our Mesh Network<a class="headerlink" href="#why-password-persists-in-our-mesh-network" title="Permanent link">¶</a></h2> <p>Looking at our deployment code in <code>playbooks/deploy.yml</code>:</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Line 133-141: Backup BEFORE configuration</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Backup current configuration</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="no">if [ ! -f /tmp/backup-{{ inventory_hostname }}-*.tar.gz ]; then</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">      </span><span class="no">sysupgrade -b /tmp/backup-{{ inventory_hostname }}-$(date +%Y%m%d-%H%M%S).tar.gz</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="no">fi</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="c1"># Line 262-263: Set root password</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set root password</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="s">"echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">'password\npassword'</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">passwd</span><span class="nv"> </span><span class="s">root"</span>
</span></code></pre></div> <h3 id="scenario-where-password-persists-after-reset">Scenario Where Password Persists After Reset<a class="headerlink" href="#scenario-where-password-persists-after-reset" title="Permanent link">¶</a></h3> <div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>1. Initial Factory OpenWrt
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>   └─ No password set
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>2. Run Deployment Playbook
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>   ├─ Create backup (sysupgrade -b) ← Backs up factory state
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>   ├─ Set root password            ← Writes to /overlay/etc/shadow
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>   ├─ Configure network/wireless
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>   └─ Node now has password in overlay
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>3. Firmware Flash Happens (user does this manually)
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>   ├─ sysupgrade -n (factory reset mode)
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>   ├─ BUT: sysupgrade.conf on this device preserves OVERLAY
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>   ├─ /overlay/etc/shadow is NOT erased
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>   └─ Password persists in overlay!
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>4. After Flash, Router Boots
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>   ├─ ROM layer has factory defaults (no password)
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>   ├─ Overlay layer has configured password
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>   ├─ Union mount gives overlay priority
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>   ├─ /etc/shadow comes from /overlay/etc/shadow
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>   └─ PASSWORD STILL SET! ⚠️
</span></code></pre></div> <h3 id="the-d-link-dir-1960-a1-specific-behavior">The D-Link DIR-1960 A1 Specific Behavior<a class="headerlink" href="#the-d-link-dir-1960-a1-specific-behavior" title="Permanent link">¶</a></h3> <p>The DIR-1960 A1 has specific sysupgrade behavior:</p> <p><strong>Overlay partition:</strong> <code>rootfs_data</code> (UBI volume)</p> <p><strong>Firmware flash default:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># When user does: sysupgrade -n image.bin</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1"># The system executes (from sysupgrade script):</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">case</span><span class="w"> </span><span class="s2">"</span><span class="nv">$UPGRADE_OPT</span><span class="s2">"</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">  </span>keep_config<span class="o">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="c1"># -n flag → factory reset mode</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="c1"># Erase rootfs_data (overlay)</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span>ubiformat<span class="w"> </span>/dev/mtd...<span class="w"> </span>-y
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="p">;;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="k">esac</span>
</span></code></pre></div> <p><strong>BUT if sysupgrade.conf has:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nv">SAVE_OVERLAY</span><span class="o">=</span><span class="m">1</span><span class="w">  </span><span class="c1"># Preserve overlay contents</span>
</span></code></pre></div> <p><strong>Then overlay is NOT erased</strong>, and password persists!</p> <hr> <h2 id="how-sysupgrade-backup-works">How sysupgrade Backup Works<a class="headerlink" href="#how-sysupgrade-backup-works" title="Permanent link">¶</a></h2> <h3 id="the-sysupgrade-b-backup-command">The sysupgrade -b (Backup) Command<a class="headerlink" href="#the-sysupgrade-b-backup-command" title="Permanent link">¶</a></h3> <p>From our backup.yml (line 24):</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create backup on remote node</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="s">"sysupgrade</span><span class="nv"> </span><span class="s">-b</span><span class="nv"> </span><span class="s">/tmp/backup-{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}-$(date</span><span class="nv"> </span><span class="s">+%Y%m%d-%H%M%S).tar.gz"</span>
</span></code></pre></div> <p>This creates a tar.gz archive containing:</p> <div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>backup-node1-20251113-120000.tar.gz
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>├── etc/
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>│   ├── config/      ← Network, wireless, firewall configs
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>│   ├── shadow       ← PASSWORD HASHES! ⚠️⚠️⚠️
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>│   ├── passwd
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>│   ├── group
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>│   ├── ssh/         ← SSH server keys and config
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>│   ├── dnsmasq.conf
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>│   └── ...
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>├── root/
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>│   ├── .ssh/        ← SSH authorized_keys
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>│   └── ...
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>└── lib/
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    └── firmware/    ← Wireless calibration data
</span></code></pre></div> <p><strong>Critical files that survive:</strong></p> <table> <thead> <tr> <th>File</th> <th>Effect</th> </tr> </thead> <tbody> <tr> <td><code>/etc/shadow</code></td> <td>Password hashes - SURVIVES</td> </tr> <tr> <td><code>/etc/config/*</code></td> <td>All configuration - SURVIVES</td> </tr> <tr> <td><code>/root/.ssh/authorized_keys</code></td> <td>SSH keys - SURVIVES</td> </tr> <tr> <td><code>/etc/ssh/sshd_config</code></td> <td>SSH config - SURVIVES</td> </tr> </tbody> </table> <h3 id="the-sysupgrade-r-restore-command">The sysupgrade -r (Restore) Command<a class="headerlink" href="#the-sysupgrade-r-restore-command" title="Permanent link">¶</a></h3> <p>From our README.md (line 368):</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># 3. Restore</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>sysupgrade<span class="w"> </span>-r<span class="w"> </span>/tmp/backup-node1-*.tar.gz
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>reboot
</span></code></pre></div> <p>This <strong>extracts and overwrites</strong> all files from the backup:</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Pseudo-code of sysupgrade -r</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>tar<span class="w"> </span>-xzf<span class="w"> </span>backup.tar.gz<span class="w"> </span>-C<span class="w"> </span>/<span class="w">  </span><span class="c1"># Extract to root!</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># Overwrites:</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>/etc/shadow<span class="w">           </span>←<span class="w"> </span>Restores<span class="w"> </span>password<span class="w"> </span><span class="nb">hash</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>/etc/config/network<span class="w">   </span>←<span class="w"> </span>Restores<span class="w"> </span>network<span class="w"> </span>config
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>/root/.ssh/authorized_keys<span class="w"> </span>←<span class="w"> </span>Restores<span class="w"> </span>SSH<span class="w"> </span>keys
</span></code></pre></div> <p><strong>Critical:</strong> This happens AFTER factory reset, so backup must be created BEFORE the reset!</p> <hr> <h2 id="complete-scenario-why-password-persisted">Complete Scenario: Why Password Persisted<a class="headerlink" href="#complete-scenario-why-password-persisted" title="Permanent link">¶</a></h2> <p>Let's trace through what likely happened:</p> <h3 id="timeline">Timeline<a class="headerlink" href="#timeline" title="Permanent link">¶</a></h3> <div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>[1] Fresh Router
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    ├─ Device: D-Link DIR-1960 A1
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    ├─ IP: 192.168.1.1
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    ├─ SSH: Dropbear with no password
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    ├─ /overlay/etc/shadow: EMPTY
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    └─ /etc/shadow: root::... (factory default, no password)
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>[2] Deployment Runs
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    ├─ make deploy-initial-node1
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    ├─ Ansible sets root password
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    └─ /overlay/etc/shadow: root:$y$j9T... (PASSWORD HASH WRITTEN)
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>[3] Configured Mesh Running
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>    ├─ IP: 10.11.12.1
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    ├─ /etc/shadow → /overlay/etc/shadow (overlay priority)
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>    ├─ Root login requires password
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    └─ Everything working normally
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>[4] User Does Manual Factory Reset
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    ├─ Method: Firmware flash via sysupgrade
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    │  sysupgrade -n openwrt-24.10...bin
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>    │
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>    └─ Result depends on device sysupgrade.conf:
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>       IF sysupgrade.conf has SAVE_OVERLAY=1:
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>       ├─ /overlay/etc/shadow: NOT ERASED ⚠️
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>       ├─ Password hash survives in overlay
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>       └─ After boot: ROOT PASSWORD STILL SET!
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>       IF overlay completely erased:
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>       ├─ /overlay/etc/shadow: ERASED
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>       ├─ /rom/etc/shadow: Factory default (no password)
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>       └─ After boot: NO PASSWORD (expected)
</span></code></pre></div> <h3 id="why-d-link-dir-1960-a1-preserves-password">Why D-Link DIR-1960 A1 Preserves Password<a class="headerlink" href="#why-d-link-dir-1960-a1-preserves-password" title="Permanent link">¶</a></h3> <p>The DIR-1960 A1 has specific behavior:</p> <ol> <li><strong>UBI Filesystem:</strong> Uses UBI (Unsorted Block Image) for overlay</li> <li><strong>sysupgrade.conf:</strong> Likely configured with <code>SAVE_OVERLAY=1</code></li> <li><strong>Overlay Mount:</strong> Overlay persists across firmware updates</li> <li><strong>Result:</strong> <code>/overlay/etc/shadow</code> survives unless explicitly erased</li> </ol> <p><strong>Verification command (if you had serial access):</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Check what sysupgrade preserves</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>cat<span class="w"> </span>/etc/sysupgrade.conf
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># Check if overlay was erased</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>mount<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>overlay
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>ls<span class="w"> </span>-la<span class="w"> </span>/overlay/etc/shadow
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="c1"># Check password status</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>cat<span class="w"> </span>/etc/shadow
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>grep<span class="w"> </span><span class="s2">"^root:"</span><span class="w"> </span>/rom/etc/shadow<span class="w">   </span><span class="c1"># ROM version (factory)</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>grep<span class="w"> </span><span class="s2">"^root:"</span><span class="w"> </span>/overlay/etc/shadow<span class="w"> </span><span class="c1"># Overlay version (configured)</span>
</span></code></pre></div> <hr> <h2 id="complete-vs-partial-factory-resets">Complete vs Partial Factory Resets<a class="headerlink" href="#complete-vs-partial-factory-resets" title="Permanent link">¶</a></h2> <h3 id="complete-factory-reset-wipes-everything">Complete Factory Reset (Wipes Everything)<a class="headerlink" href="#complete-factory-reset-wipes-everything" title="Permanent link">¶</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Via serial console:</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>mtd<span class="w"> </span>erase<span class="w"> </span>rootfs_data<span class="w">  </span><span class="c1"># Erase overlay partition completely</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>reboot
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="c1"># OR via web UI reset button</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="c1"># Typically: 5-10 second press</span>
</span></code></pre></div> <p><strong>Effect:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>✓ /rom/etc/shadow restored (factory default, no password)
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>✗ /overlay/etc/shadow erased completely
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>✓ Dropbear SSH with no password
</span></code></pre></div> <p><strong>Password survives?</strong> NO ❌</p> <hr> <h3 id="partialselective-factory-reset-sysupgrade-n">Partial/Selective Factory Reset (sysupgrade -n)<a class="headerlink" href="#partialselective-factory-reset-sysupgrade-n" title="Permanent link">¶</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># Via SSH or web UI update</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>sysupgrade<span class="w"> </span>-n<span class="w"> </span>openwrt-24.10-squashfs-sysupgrade.bin
</span></code></pre></div> <p><strong>Effect (depends on sysupgrade.conf):</strong></p> <div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>⚠️  /rom/etc/shadow refreshed (new firmware)
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>⚠️  /overlay/etc/shadow MAY persist
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>⚠️  Result depends on device
</span></code></pre></div> <p><strong>Password survives?</strong> MAYBE ⚠️</p> <hr> <h3 id="backup-assisted-reset-most-likely-scenario-in-our-case">Backup-Assisted Reset (Most Likely Scenario in Our Case)<a class="headerlink" href="#backup-assisted-reset-most-likely-scenario-in-our-case" title="Permanent link">¶</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Create backup before any reset</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>sysupgrade<span class="w"> </span>-b<span class="w"> </span>backup.tar.gz
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># Then at some point:</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>sysupgrade<span class="w"> </span>-n<span class="w"> </span>image.bin<span class="w">  </span><span class="c1"># OR manual factory reset</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="c1"># Then restore from backup</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>sysupgrade<span class="w"> </span>-r<span class="w"> </span>backup.tar.gz
</span></code></pre></div> <p><strong>Effect:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>✓ All files explicitly restored from archive
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>✓ /etc/shadow restored with password hash
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>✓ /etc/config restored with all settings
</span></code></pre></div> <p><strong>Password survives?</strong> YES ✅ (Explicitly)</p> <hr> <h2 id="our-deployments-role">Our Deployment's Role<a class="headerlink" href="#our-deployments-role" title="Permanent link">¶</a></h2> <h3 id="what-our-playbook-does">What Our Playbook Does<a class="headerlink" href="#what-our-playbook-does" title="Permanent link">¶</a></h3> <p>From <code>playbooks/deploy.yml</code>:</p> <p><strong>Phase 1: Backup (Line 133-141)</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Backup current configuration</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">  </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="no">sysupgrade -b /tmp/backup-{{ inventory_hostname }}-$(date +%Y%m%d-%H%M%S).tar.gz</span>
</span></code></pre></div> <p><strong>Creates:</strong> <code>backup-node1-20251113-120000.tar.gz</code> <strong>Contains:</strong> All <code>/etc/config</code>, <code>/etc/shadow</code>, <code>/root/.ssh</code>, etc. <strong>Stored on node in:</strong> <code>/tmp/backup-*.tar.gz</code></p> <p><strong>Phase 2: Set Password (Line 262-263)</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set root password</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">  </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="s">"echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">'password\npassword'</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">passwd</span><span class="nv"> </span><span class="s">root"</span>
</span></code></pre></div> <p><strong>Effect:</strong> Writes to <code>/overlay/etc/shadow</code> <strong>File:</strong> <code>/overlay/etc/shadow</code> (not <code>/rom/etc/shadow</code>) <strong>Stored in:</strong> Overlay partition (JFFS2)</p> <h3 id="how-this-leads-to-password-persistence">How This Leads to Password Persistence<a class="headerlink" href="#how-this-leads-to-password-persistence" title="Permanent link">¶</a></h3> <ol> <li><strong>Backup includes the new password</strong> (written in Phase 2)</li> <li><strong>If operator creates a new backup after deployment:</strong></li> </ol> <div class="language-bash highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># User might do this from their control machine:</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>ansible-playbook<span class="w"> </span>playbooks/backup.yml
</span></code></pre></div> <p>This fetches the backup to control machine</p> <ol> <li><strong>If user later restores from this backup:</strong></li> </ol> <div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1"># User manually restores via sysupgrade -r</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>scp<span class="w"> </span>backup-node1-*.tar.gz<span class="w"> </span>root@10.11.12.1:/tmp/
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>ssh<span class="w"> </span>root@10.11.12.1
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>sysupgrade<span class="w"> </span>-r<span class="w"> </span>/tmp/backup-node1-*.tar.gz
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>reboot
</span></code></pre></div> <p>Password is explicitly restored!</p> <hr> <h2 id="file-persistence-matrix">File Persistence Matrix<a class="headerlink" href="#file-persistence-matrix" title="Permanent link">¶</a></h2> <p>This table shows which files survive different reset scenarios:</p> <div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>File                      | Factory Reset | sysupgrade -n | sysupgrade -r |
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>                          | (mtd erase)   | (device dep)  | (explicit)    |
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>──────────────────────────┼───────────────┼───────────────┼───────────────┤
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>/rom/etc/shadow           | ✓ Factory     | ✓ Factory     | ✓ From backup |
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>/overlay/etc/shadow       | ✗ ERASED      | ⚠️  MAYBE      | ✓ Restored    |
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>/etc/config/*             | ✗ ERASED      | ⚠️  MAYBE      | ✓ Restored    |
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>/etc/ssh/                 | ✗ ERASED      | ⚠️  MAYBE      | ✓ Restored    |
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>/root/.ssh/authorized_keys| ✗ ERASED      | ⚠️  MAYBE      | ✓ Restored    |
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>Wireless calibration      | ✓ Preserved   | ✓ Preserved   | ✓ Preserved   |
</span></code></pre></div> <hr> <h2 id="technical-deep-dive-openwrt-boot-process">Technical Deep Dive: OpenWrt Boot Process<a class="headerlink" href="#technical-deep-dive-openwrt-boot-process" title="Permanent link">¶</a></h2> <p>Understanding how OpenWrt boots helps explain persistence:</p> <h3 id="boot-sequence">Boot Sequence<a class="headerlink" href="#boot-sequence" title="Permanent link">¶</a></h3> <div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>[1] Bootloader starts
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    └─ ROM firmware loads
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>[2] Kernel mounts filesystems
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    ├─ Mount /rom (squashfs, read-only)
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    ├─ Mount /overlay (JFFS2 or UBI, read-write)
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>    └─ Create union mount at /
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>[3] Init scripts run
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>    ├─ /etc/init.d/rcS (reads from union view)
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>    ├─ Checks /etc/shadow (gets overlay version if exists)
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>    └─ SSH service uses /etc/shadow for auth
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>[4] SSH Server Starts (Dropbear or OpenSSH)
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>    ├─ Reads /etc/shadow from /overlay/etc/shadow
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>    │  (if it exists, overlays ROM version)
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>    ├─ Uses password hash for authentication
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>    └─ Root login allowed if password hash exists
</span></code></pre></div> <h3 id="union-mount-priority">Union Mount Priority<a class="headerlink" href="#union-mount-priority" title="Permanent link">¶</a></h3> <div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>User space view of /etc:
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>├─ Overlay files first   ← Checked first
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>├─ ROM files fallback     ← If not in overlay
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>└─ Result: Overlay takes absolute priority
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>Example: /etc/shadow lookup
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>1. Check /overlay/etc/shadow
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>2. If found → USE IT (stop looking)
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>3. If not found → Check /rom/etc/shadow
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>4. If found → USE IT
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>If /overlay has shadow with password hash:
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>└─ ROM's empty shadow is NEVER used!
</span></code></pre></div> <hr> <h2 id="prevention-ensuring-clean-factory-reset">Prevention: Ensuring Clean Factory Reset<a class="headerlink" href="#prevention-ensuring-clean-factory-reset" title="Permanent link">¶</a></h2> <h3 id="method-1-complete-overlay-erase-most-secure">Method 1: Complete Overlay Erase (Most Secure)<a class="headerlink" href="#method-1-complete-overlay-erase-most-secure" title="Permanent link">¶</a></h3> <p>Via serial console or U-Boot:</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Method A: Via UCI from OpenWrt</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>mtd<span class="w"> </span>erase<span class="w"> </span>rootfs_data
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>reboot
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="c1"># Method B: Via U-Boot (requires serial)</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>mtd<span class="w"> </span>erase<span class="w"> </span>/dev/mtdX<span class="w">  </span><span class="c1"># Where X is overlay partition</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c1"># Method C: Wipe entire device (nuclear option)</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>mtd<span class="w"> </span>erase<span class="w"> </span>all
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>reboot
</span></code></pre></div> <p><strong>Effect:</strong> Overlay completely wiped, password gone ✅</p> <hr> <h3 id="method-2-factory-reset-button">Method 2: Factory Reset Button<a class="headerlink" href="#method-2-factory-reset-button" title="Permanent link">¶</a></h3> <p><strong>Hardware:</strong> Press reset button</p> <p><strong>D-Link DIR-1960 A1:</strong> Press reset button for 5-10 seconds</p> <p><strong>Process:</strong></p> <ol> <li>Device detects long press</li> <li>Executes <code>firstboot</code> command</li> <li>Erases overlay via <code>mtd erase rootfs_data</code></li> <li>Reboots</li> </ol> <p><strong>Effect:</strong> Clean reset, no password ✅</p> <hr> <h3 id="method-3-secure-firmware-flash">Method 3: Secure Firmware Flash<a class="headerlink" href="#method-3-secure-firmware-flash" title="Permanent link">¶</a></h3> <p>Explicitly preserve nothing:</p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># When available (device-specific)</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>sysupgrade<span class="w"> </span>-F<span class="w"> </span>-n<span class="w"> </span>image.bin
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="c1"># -F = Force factory defaults (if supported)</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="c1"># -n = No configuration preservation</span>
</span></code></pre></div> <p><strong>Check device sysupgrade.conf:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># If device has this configuration</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nv">SAVE_CONFIG</span><span class="o">=</span><span class="m">0</span><span class="w">   </span><span class="c1"># Don't preserve config</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="nv">SAVE_OVERLAY</span><span class="o">=</span><span class="m">0</span><span class="w">  </span><span class="c1"># Don't preserve overlay</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="nv">SKIP_VALIDATION</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="c1"># Then sysupgrade will be clean</span>
</span></code></pre></div> <hr> <h2 id="our-deployment-improvements">Our Deployment Improvements<a class="headerlink" href="#our-deployment-improvements" title="Permanent link">¶</a></h2> <h3 id="current-behavior-what-happens-now">Current Behavior (What Happens Now)<a class="headerlink" href="#current-behavior-what-happens-now" title="Permanent link">¶</a></h3> <ol> <li>✅ Creates backup before any changes</li> <li>✅ Sets password in overlay</li> <li>⚠️ Backup is stored on node in <code>/tmp/</code></li> <li>⚠️ Backup contains password hash</li> <li>⚠️ If user restores backup, password comes back</li> </ol> <h3 id="recommended-improvements">Recommended Improvements<a class="headerlink" href="#recommended-improvements" title="Permanent link">¶</a></h3> <p><strong>In <code>playbooks/backup.yml</code> (already implemented):</strong></p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Line 33-37: Fetch backup to control machine</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fetch backup to control machine</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">  </span><span class="nt">fetch</span><span class="p">:</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">backup_file.stdout</span><span class="nv"> </span><span class="s">}}"</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">backup_dir</span><span class="nv"> </span><span class="s">}}/"</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="nt">flat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</span></code></pre></div> <p><strong>Good:</strong> Backup is fetched to control machine</p> <p><strong>Could be better:</strong></p> <ol> <li><strong>Add backup encryption:</strong></li> </ol> <div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Encrypt backup before storing</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>gpg<span class="w"> </span>-c<span class="w"> </span>backup-node1-*.tar.gz
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>rm<span class="w"> </span>backup-node1-*.tar.gz<span class="w">  </span><span class="c1"># Remove unencrypted</span>
</span></code></pre></div> <ol> <li><strong>Add backup integrity verification:</strong></li> </ol> <div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1"># Calculate checksum</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>sha256sum<span class="w"> </span>backup-node1-*.tar.gz<span class="w"> </span>&gt;<span class="w"> </span>backup-node1-*.sha256
</span></code></pre></div> <ol> <li><strong>Document restore process:</strong></li> <li>Make it clear what gets restored</li> <li>Warn about password restoration</li> <li>Provide option to restore selectively</li> </ol> <hr> <h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">¶</a></h2> <p>The OpenWrt D-Link DIR-1960 A1 retains the root password after factory reset because:</p> <ol> <li><strong>Overlay persistence</strong> - The <code>/overlay/etc/shadow</code> file containing the password hash may survive certain factory reset methods</li> <li><strong>Union filesystem</strong> - OpenWrt's layered filesystem gives overlay files priority over ROM files</li> <li><strong>Selective reset behavior</strong> - <code>sysupgrade -n</code> may preserve overlay depending on device configuration</li> <li><strong>Backup restoration</strong> - If backups were created and later restored, password is explicitly restored</li> <li><strong>Device-specific sysupgrade.conf</strong> - DIR-1960 A1 may have <code>SAVE_OVERLAY=1</code> configured</li> </ol> <p><strong>To ensure clean password-free reset:</strong></p> <ul> <li>Use complete overlay erase (<code>mtd erase rootfs_data</code>)</li> <li>Or use factory reset button</li> <li>Or verify <code>sysupgrade.conf</code> has <code>SAVE_OVERLAY=0</code></li> </ul> <hr> <h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">¶</a></h2> <h3 id="openwrt-documentation">OpenWrt Documentation<a class="headerlink" href="#openwrt-documentation" title="Permanent link">¶</a></h3> <ul> <li><a href="https://openwrt.org/docs/guide_user/advanced/filesystem">OpenWrt Filesystem Documentation</a></li> <li><a href="https://openwrt.org/docs/guide_user/installation/generic.sysupgrade">sysupgrade Documentation</a></li> <li><a href="https://openwrt.org/docs/guide_user/advanced/failsafe_and_factory_reset">Factory Reset Guide</a></li> </ul> <h3 id="our-codebase">Our Codebase<a class="headerlink" href="#our-codebase" title="Permanent link">¶</a></h3> <ul> <li><code>playbooks/deploy.yml</code> - Lines 133-263: Backup and password management</li> <li><code>playbooks/backup.yml</code> - Lines 24-57: Backup and restore procedures</li> <li><code>README.md</code> - Lines 357-370: Restore instructions</li> </ul> <h3 id="technical-details">Technical Details<a class="headerlink" href="#technical-details" title="Permanent link">¶</a></h3> <ul> <li>UBI (Unsorted Block Image): Used for NAND flash on DIR-1960 A1</li> <li>JFFS2 (Journalling Flash File System 2): Overlay filesystem</li> <li>Union mounts: Layered filesystem view</li> <li>MTD (Memory Technology Device): Linux flash device interface</li> </ul> <hr> <p><strong>Last Updated:</strong> 2025-11-13 <strong>Device:</strong> D-Link DIR-1960 A1 <strong>OpenWrt Version:</strong> 24.10.4 <strong>Research Completed:</strong> Comprehensive technical analysis</p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="November 17, 2025 02:47:13 UTC"><span class="timeago" datetime="2025-11-17T02:47:13+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="November 17, 2025 02:47:13 UTC">2025-11-17</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="Created"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="November 17, 2025 02:47:13 UTC"><span class="timeago" datetime="2025-11-17T02:47:13+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="November 17, 2025 02:47:13 UTC">2025-11-17</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type="button" class="md-top md-icon" data-md-component="top" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 OpenWrt Mesh Network Project </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> <div class="md-social"> <a href="https://github.com/git-kubik/mesh" target="_blank" rel="noopener" title="github.com" class="md-social__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a href="https://hub.docker.com/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.action.edit", "content.action.view"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script> <script src="../../js/timeago.min.js"></script> <script src="../../js/timeago_mkdocs_material.js"></script>  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>