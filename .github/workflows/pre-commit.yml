name: Pre-commit Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  pre-commit:
    name: Run pre-commit hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pre-commit environment
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Upload pre-commit results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pre-commit-results
          path: |
            **/*.diff
            .pre-commit-log

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Check code formatting with Black
        run: black --check --line-length 100 --diff .

      - name: Check import sorting with isort
        run: isort --check-only --profile black --diff .

      - name: Lint with flake8
        run: |
          flake8 . \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --max-complexity=10 \
            --count \
            --statistics

      - name: Type check with mypy
        run: mypy tests/ --strict --ignore-missing-imports || true

      - name: Lint Ansible playbooks
        run: |
          ansible-lint openwrt-mesh-ansible/ \
            --profile=production \
            --force-color || true

      - name: Lint YAML files
        run: yamllint -c .yamllint.yaml . || true

      - name: Lint Markdown files
        run: markdownlint '**/*.md' --ignore node_modules || true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Scan for secrets
        run: |
          detect-secrets scan --baseline .secrets.baseline \
            --exclude-files '\.secrets\.baseline$' \
            --exclude-files '\.git/.*' \
            --exclude-files 'node_modules/.*'

      - name: Check for known vulnerabilities in Python dependencies
        run: |
          pip install safety
          safety check --json || true

      - name: Check file permissions
        run: |
          # Check for overly permissive files
          find . -type f -perm /go+w -not -path "./.git/*" -not -path "./node_modules/*" | while read file; do
            echo "WARNING: $file is world-writable"
          done

      - name: Check for hardcoded IPs and passwords
        run: |
          # Check for common patterns (basic check)
          ! grep -r "password.*=.*['\"]" --include="*.py" --include="*.yml" . || echo "Warning: Found potential hardcoded passwords"
          ! grep -rE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" --include="*.py" . | grep -v "10.11.12" || echo "Info: Found IP addresses"

  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs
        run: |
          pip install -r requirements-docs.txt 2>/dev/null || \
          pip install mkdocs mkdocs-material mkdocs-git-revision-date-localized-plugin mkdocs-minify-plugin mkdocs-glightbox

      - name: Build documentation
        run: |
          if [ -f mkdocs.yml ]; then
            mkdocs build --strict --verbose
          else
            echo "No mkdocs.yml found, skipping documentation build"
          fi

      - name: Check for broken links
        if: hashFiles('mkdocs.yml') != ''
        run: |
          # Install link checker
          npm install -g markdown-link-check
          # Check all markdown files
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./site/*" -exec markdown-link-check {} \; || true

  summary:
    name: Status Summary
    runs-on: ubuntu-latest
    needs: [pre-commit, code-quality, security, documentation]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "## Pre-commit Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit Hooks | ${{ needs.pre-commit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: |
          needs.pre-commit.result == 'failure' ||
          needs.code-quality.result == 'failure'
        run: |
          echo "One or more checks failed. Please review the logs above."
          exit 1
