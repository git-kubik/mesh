---
# ============================================================================
# OpenWrt Mesh Network - Global Variables
# ============================================================================
#
# ALL values are sourced from environment variables (.env file)
# See .env.example for complete documentation and examples
#
# Usage:
#   1. Copy .env.example to .env
#   2. Configure all values in .env
#   3. Load environment: set -a; source .env; set +a
#   4. Deploy: make deploy-initial-node1
#
# Documentation: docs/ENV-CONFIGURATION.md
# ============================================================================

# ============================================================================
# OpenWrt Target Configuration
# ============================================================================

openwrt_version: "{{ lookup('env', 'OPENWRT_VERSION') | default('24.10.4', true) }}"
openwrt_target: "{{ lookup('env', 'OPENWRT_TARGET') | default('ramips/mt7621', true) }}"
openwrt_arch: "{{ lookup('env', 'OPENWRT_ARCH') | default('mipsel_24kc', true) }}"

# ============================================================================
# Local Package Repository Configuration
# ============================================================================

opkg_repo_url: "{{ lookup('env', 'OPKG_REPO_URL') | default('', true) }}"

# ============================================================================
# Deployment Options
# ============================================================================

skip_reboot: "{{ lookup('env', 'SKIP_REBOOT') | default('false', true) | bool }}"

# ============================================================================
# SSH & System Security Configuration
# ============================================================================
# NOTE: Factory OpenWrt uses Dropbear SSH with NO root password set
#       Deployment switches to OpenSSH with SSH KEY authentication

# Root password (used for console access, NOT for SSH)
root_password: "{{ lookup('env', 'ROOT_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"

# SSH Key Configuration
ssh_key_path: "{{ lookup('env', 'SSH_KEY_PATH') | default('~/.ssh/openwrt_mesh_rsa', true) }}"
ssh_key_type: "{{ lookup('env', 'SSH_KEY_TYPE') | default('rsa', true) }}"
ssh_key_bits: "{{ lookup('env', 'SSH_KEY_BITS') | default('4096', true) | int }}"
ssh_key_comment: "{{ lookup('env', 'SSH_KEY_COMMENT') | default('ansible@openwrt-mesh', true) }}"

# ============================================================================
# Network Configuration
# ============================================================================

mesh_network: "{{ lookup('env', 'MESH_NETWORK') | default('10.11.12.0', true) }}"
mesh_netmask: "{{ lookup('env', 'MESH_NETMASK') | default('255.255.255.0', true) }}"
mesh_cidr: "{{ lookup('env', 'MESH_CIDR') | default('24', true) | int }}"
mesh_gateway: "{{ lookup('env', 'MESH_GATEWAY') | default('10.11.12.1', true) }}"

# DNS Servers
dns_servers:
  - "{{ lookup('env', 'DNS_PRIMARY') | default('1.1.1.1', true) }}"
  - "{{ lookup('env', 'DNS_SECONDARY') | default('8.8.8.8', true) }}"

# ============================================================================
# DHCP Configuration
# ============================================================================

dhcp_leasetime: "{{ lookup('env', 'DHCP_LEASETIME') | default('12h', true) }}"

# Per-node DHCP pools
dhcp_pools:
  node1:
    start: "{{ lookup('env', 'DHCP_NODE1_START') | default('100', true) | int }}"
    limit: "{{ lookup('env', 'DHCP_NODE1_LIMIT') | default('50', true) | int }}"
  node2:
    start: "{{ lookup('env', 'DHCP_NODE2_START') | default('150', true) | int }}"
    limit: "{{ lookup('env', 'DHCP_NODE2_LIMIT') | default('50', true) | int }}"
  node3:
    start: "{{ lookup('env', 'DHCP_NODE3_START') | default('200', true) | int }}"
    limit: "{{ lookup('env', 'DHCP_NODE3_LIMIT') | default('50', true) | int }}"

# Static Host Reservations (optional)
# These work across all networks - dnsmasq matches by IP subnet
# Add MAC addresses after discovering them from your devices
static_hosts:
  # Management/Infrastructure (10.11.10.x)
  - name: rpi-qdevice
    mac: 'dc:a6:32:94:67:eb'
    ip: 10.11.10.20
#  - name: proxmox1
#    mac: 'XX:XX:XX:XX:XX:XX'  # Get from: ip link show eth0
#    ip: 10.11.10.21
#  - name: proxmox2
#    mac: 'XX:XX:XX:XX:XX:XX'  # Get from: ip link show eth0
#    ip: 10.11.10.22
#
#  # LAN examples (10.11.12.x)
#  - name: admin-workstation
#    mac: 'AA:BB:CC:DD:EE:FF'
#    ip: 10.11.12.10
#
#  # IoT examples (10.11.30.x)
#  - name: homeassistant-vm
#    mac: 'AA:BB:CC:DD:EE:03'
#    ip: 10.11.30.50

# ============================================================================
# Batman-adv Configuration
# ============================================================================

batman_routing_algo: "{{ lookup('env', 'BATMAN_ROUTING_ALGO') | default('BATMAN_V', true) }}"

# ============================================================================
# ARP Cache Configuration (Management Network Stability)
# ============================================================================
# Longer ARP cache times prevent intermittent connectivity issues in multi-switch
# topologies where MAC/ARP relearning can cause brief outages.
# These settings apply to br-mgmt (management bridge) interface.

arp_gc_stale_time: "{{ lookup('env', 'ARP_GC_STALE_TIME') | default('300', true) | int }}"
arp_base_reachable_time_ms: "{{ lookup('env', 'ARP_BASE_REACHABLE_TIME_MS') | default('120000', true) | int }}"
batman_gw_bandwidth: "{{ lookup('env', 'BATMAN_GW_BANDWIDTH') | default('100000/100000', true) }}"
batman_orig_interval: "{{ lookup('env', 'BATMAN_ORIG_INTERVAL') | default('500', true) | int }}"

# Per-interface hop penalties to prevent wired/wireless route flapping
batman_hop_penalty_wired: "{{ lookup('env', 'BATMAN_HOP_PENALTY_WIRED') | default('5', true) | int }}"
batman_hop_penalty_wireless: "{{ lookup('env', 'BATMAN_HOP_PENALTY_WIRELESS') | default('30', true) | int }}"

# Legacy hop penalty (deprecated, kept for compatibility)
batman_hop_penalty: "{{ lookup('env', 'BATMAN_HOP_PENALTY') | default('15', true) | int }}"

# ============================================================================
# Wireless Mesh Configuration (2.4GHz - Backbone)
# ============================================================================

mesh_id: "{{ lookup('env', 'MESH_ID') | default('HA-Mesh', true) }}"
mesh_encryption: "{{ lookup('env', 'MESH_ENCRYPTION') | default('sae', true) }}"
mesh_password: "{{ lookup('env', 'MESH_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"
mesh_channel: "{{ lookup('env', 'MESH_CHANNEL') | default('6', true) | int }}"
mesh_htmode: "{{ lookup('env', 'MESH_HTMODE') | default('HT40', true) }}"
mesh_mcast_rate: "{{ lookup('env', 'MESH_MCAST_RATE') | default('24000', true) | int }}"

# ============================================================================
# Client WiFi Configuration (5GHz - Access Point)
# ============================================================================

client_ssid: "{{ lookup('env', 'CLIENT_SSID') | default('HA-Client', true) }}"
client_encryption: "{{ lookup('env', 'CLIENT_ENCRYPTION') | default('psk2+ccmp', true) }}"
client_password: "{{ lookup('env', 'CLIENT_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"
client_channel: "{{ lookup('env', 'CLIENT_CHANNEL') | default('36', true) | int }}"
client_htmode: "{{ lookup('env', 'CLIENT_HTMODE') | default('VHT80', true) }}"
client_country: "{{ lookup('env', 'CLIENT_COUNTRY') | default('AU', true) }}"

# ============================================================================
# 802.11r Fast Roaming
# ============================================================================

enable_80211r: "{{ lookup('env', 'ENABLE_80211R') | default('true', true) | bool }}"
mobility_domain: "{{ lookup('env', 'MOBILITY_DOMAIN') | default('a1b2', true) }}"

# ============================================================================
# MTU Configuration
# ============================================================================

mtu_wired_mesh: "{{ lookup('env', 'MTU_WIRED_MESH') | default('1560', true) | int }}"
mtu_wireless_mesh: "{{ lookup('env', 'MTU_WIRELESS_MESH') | default('1532', true) | int }}"

# ============================================================================
# Package Configuration
# ============================================================================

# Required packages (converted from comma-separated string to list)
required_packages: "{{ lookup('env', 'REQUIRED_PACKAGES') | default('python3,batctl-full,kmod-batman-adv,wpad-mesh-mbedtls,ip-full,tcpdump-mini,openssh-server,openssh-sftp-server,openssh-keygen,openssh-client,curl', true) | split(',') }}"

# Packages to remove (converted from comma-separated string to list)
remove_packages: "{{ lookup('env', 'REMOVE_PACKAGES') | default('wpad-basic-mbedtls,wpad-basic-wolfssl,wpad-basic', true) | split(',') }}"

# Optional packages (converted from comma-separated string to list)
optional_packages: "{{ lookup('env', 'OPTIONAL_PACKAGES') | default('iperf3,ethtool,nano,htop,rsync', true) | split(',') }}"

# ============================================================================
# System Configuration
# ============================================================================

timezone: "{{ lookup('env', 'TIMEZONE') | default('ACST-9:30ACDT,M10.1.0,M4.1.0/3', true) }}"
zonename: "{{ lookup('env', 'ZONENAME') | default('Australia/Adelaide', true) }}"
hostname_prefix: "{{ lookup('env', 'HOSTNAME_PREFIX') | default('mesh-node', true) }}"

# NTP servers (converted from comma-separated string to list)
ntp_servers: "{{ lookup('env', 'NTP_SERVERS') | default('0.au.pool.ntp.org,1.au.pool.ntp.org,2.au.pool.ntp.org,3.au.pool.ntp.org', true) | split(',') }}"

# ============================================================================
# Service Configuration
# ============================================================================

# Services to enable on boot (converted from comma-separated string to list)
enable_services: "{{ lookup('env', 'ENABLE_SERVICES') | default('network,firewall,dnsmasq,sshd', true) | split(',') }}"

# ============================================================================
# Security Hardening Configuration
# ============================================================================
# See docs/security/security-hardening.md for detailed documentation
# Run playbooks/security_audit.yml for comprehensive security scanning
# Run playbooks/security_check.yml for quick security validation

# Master switch - enable/disable all security hardening
security_hardening_enabled: "{{ lookup('env', 'SECURITY_HARDENING_ENABLED') | default('true', true) | bool }}"

# HTTPS/TLS Configuration
security_https_enabled: "{{ lookup('env', 'SECURITY_HTTPS_ENABLED') | default('true', true) | bool }}"
security_tls_cert_days: "{{ lookup('env', 'SECURITY_TLS_CERT_DAYS') | default('3650', true) | int }}"
security_tls_cert_country: "{{ lookup('env', 'SECURITY_TLS_CERT_COUNTRY') | default('AU', true) }}"
security_tls_cert_org: "{{ lookup('env', 'SECURITY_TLS_CERT_ORG') | default('Mesh Network', true) }}"

# HTTP Security Headers
security_http_headers_enabled: "{{ lookup('env', 'SECURITY_HTTP_HEADERS_ENABLED') | default('true', true) | bool }}"
security_http_redirect_enabled: "{{ lookup('env', 'SECURITY_HTTP_REDIRECT_ENABLED') | default('true', true) | bool }}"

# SSH Hardening
security_ssh_hardening_enabled: "{{ lookup('env', 'SECURITY_SSH_HARDENING_ENABLED') | default('true', true) | bool }}"
security_ssh_max_auth_tries: "{{ lookup('env', 'SECURITY_SSH_MAX_AUTH_TRIES') | default('3', true) | int }}"
security_ssh_login_grace_time: "{{ lookup('env', 'SECURITY_SSH_LOGIN_GRACE_TIME') | default('30', true) | int }}"
security_ssh_max_sessions: "{{ lookup('env', 'SECURITY_SSH_MAX_SESSIONS') | default('5', true) | int }}"
security_ssh_client_alive_interval: "{{ lookup('env', 'SECURITY_SSH_CLIENT_ALIVE_INTERVAL') | default('300', true) | int }}"
security_ssh_client_alive_count_max: "{{ lookup('env', 'SECURITY_SSH_CLIENT_ALIVE_COUNT_MAX') | default('2', true) | int }}"

# Rate Limiting
security_rate_limiting_enabled: "{{ lookup('env', 'SECURITY_RATE_LIMITING_ENABLED') | default('true', true) | bool }}"
security_rate_limit_ssh_per_minute: "{{ lookup('env', 'SECURITY_RATE_LIMIT_SSH') | default('3', true) | int }}"
security_rate_limit_icmp_per_second: "{{ lookup('env', 'SECURITY_RATE_LIMIT_ICMP') | default('10', true) | int }}"

# Service Hardening
security_service_hardening_enabled: "{{ lookup('env', 'SECURITY_SERVICE_HARDENING_ENABLED') | default('true', true) | bool }}"
security_disable_services:
  - odhcpd  # IPv6 DHCP - not used in this network

# Security Logging
security_syslog_local_enabled: "{{ lookup('env', 'SECURITY_SYSLOG_LOCAL_ENABLED') | default('true', true) | bool }}"
security_syslog_remote_enabled: "{{ lookup('env', 'SECURITY_SYSLOG_REMOTE_ENABLED') | default('false', true) | bool }}"
security_syslog_server: "{{ lookup('env', 'SECURITY_SYSLOG_SERVER') | default('', true) }}"
security_syslog_level: "{{ lookup('env', 'SECURITY_SYSLOG_LEVEL') | default('warning', true) }}"

# Security Validation
security_validation_enabled: "{{ lookup('env', 'SECURITY_VALIDATION_ENABLED') | default('true', true) | bool }}"
security_validation_fail_on_error: "{{ lookup('env', 'SECURITY_VALIDATION_FAIL_ON_ERROR') | default('false', true) | bool }}"

# ============================================================================
# Switch Integration Configuration
# ============================================================================
# Three TP-Link TL-SG108E managed switches for mesh redundancy and VLAN trunking
# Switch A/B (LAN3): All VLANs - primary and redundant client traffic paths
# Switch C (LAN4): Mesh VLAN 100 only - prevents L2 loops (BLA design)
# See docs/architecture/switch-integration.md for setup guide

# VLAN IDs for switch trunk ports
switch_mesh_vlan: "{{ lookup('env', 'SWITCH_MESH_VLAN') | default('100', true) | int }}"
switch_client_vlan: "{{ lookup('env', 'SWITCH_CLIENT_VLAN') | default('200', true) | int }}"

# Switch management IPs (for documentation/monitoring)
switch_a_ip: "{{ lookup('env', 'SWITCH_A_IP') | default('10.11.10.11', true) }}"
switch_b_ip: "{{ lookup('env', 'SWITCH_B_IP') | default('10.11.10.12', true) }}"
switch_c_ip: "{{ lookup('env', 'SWITCH_C_IP') | default('10.11.10.13', true) }}"

# ============================================================================
# IoT/Infrastructure Network Configuration (LAN2)
# ============================================================================
# Separate network for IoT devices, Proxmox servers, etc.
# Isolated from LAN but has internet access

iot_vlan: "{{ lookup('env', 'IOT_VLAN') | default('30', true) | int }}"
iot_network: "{{ lookup('env', 'IOT_NETWORK') | default('10.11.30.0', true) }}"
iot_netmask: "{{ lookup('env', 'IOT_NETMASK') | default('255.255.255.0', true) }}"
iot_gateway: "{{ lookup('env', 'IOT_GATEWAY') | default('10.11.30.1', true) }}"
iot_dhcp_start: "{{ lookup('env', 'IOT_DHCP_START') | default('100', true) | int }}"
iot_dhcp_limit: "{{ lookup('env', 'IOT_DHCP_LIMIT') | default('100', true) | int }}"
iot_ssid: "{{ lookup('env', 'IOT_SSID') | default('HA-IoT', true) }}"
iot_password: "{{ lookup('env', 'IOT_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"
iot_encryption: "{{ lookup('env', 'IOT_ENCRYPTION') | default('psk2+ccmp', true) }}"

# ============================================================================
# VLAN Configuration (Optional Multi-Network Support)
# ============================================================================

enable_vlans: "{{ lookup('env', 'ENABLE_VLANS') | default('true', true) | bool }}"

# VLAN Definitions (for WiFi VLANs - management and guest)
vlans:
  management:
    vid: "{{ lookup('env', 'MGMT_VLAN_VID') | default('10', true) | int }}"
    network: "{{ lookup('env', 'MGMT_VLAN_NETWORK') | default('10.11.10.0/24', true) }}"
    gateway_ip: "{{ lookup('env', 'MGMT_VLAN_GATEWAY') | default('10.11.10.1', true) }}"
    netmask: "255.255.255.0"
    dhcp_start: "{{ lookup('env', 'MGMT_VLAN_DHCP_START') | default('100', true) | int }}"
    dhcp_limit: "{{ lookup('env', 'MGMT_VLAN_DHCP_LIMIT') | default('50', true) | int }}"
    description: "Management network - 2.4GHz AP for admin access"
    ssid: "{{ lookup('env', 'MGMT_VLAN_SSID') | default('HA-Management', true) }}"
    password: "{{ lookup('env', 'MGMT_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"
    encryption: "{{ lookup('env', 'MGMT_VLAN_ENCRYPTION') | default('psk2+ccmp', true) }}"

  guest:
    vid: "{{ lookup('env', 'GUEST_VLAN_VID') | default('20', true) | int }}"
    network: "{{ lookup('env', 'GUEST_VLAN_NETWORK') | default('10.11.20.0/24', true) }}"
    gateway_ip: "{{ lookup('env', 'GUEST_VLAN_GATEWAY') | default('10.11.20.1', true) }}"
    netmask: "255.255.255.0"
    dhcp_start: "{{ lookup('env', 'GUEST_VLAN_DHCP_START') | default('100', true) | int }}"
    dhcp_limit: "{{ lookup('env', 'GUEST_VLAN_DHCP_LIMIT') | default('50', true) | int }}"
    isolation: "{{ lookup('env', 'GUEST_VLAN_ISOLATION') | default('true', true) | bool }}"
    description: "Guest network - 5GHz AP with LAN isolation"
    ssid: "{{ lookup('env', 'GUEST_VLAN_SSID') | default('HA-Guest', true) }}"
    password: "{{ lookup('env', 'GUEST_PASSWORD') | default('CHANGE_THIS_PASSWORD', true) }}"
    encryption: "{{ lookup('env', 'GUEST_VLAN_ENCRYPTION') | default('psk2+ccmp', true) }}"
