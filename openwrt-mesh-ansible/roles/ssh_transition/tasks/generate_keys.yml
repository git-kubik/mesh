---
# Phase 2: Generate SSH key on control machine (if needed)

- name: Check if SSH key exists on control machine
  ansible.builtin.stat:
    path: "{{ ssh_key_path }}"
  delegate_to: localhost
  register: ssh_key_stat
  run_once: true

- name: Generate SSH key pair if it doesn't exist
  ansible.builtin.command: >
    ssh-keygen -t {{ ssh_key_type }}
    -b {{ ssh_key_bits }}
    -f {{ ssh_key_path }}
    -C "{{ ssh_key_comment }}"
    -N ""
  delegate_to: localhost
  when: not ssh_key_stat.stat.exists
  run_once: true
  changed_when: true

- name: Set SSH key permissions
  ansible.builtin.file:
    path: "{{ ssh_key_path }}"
    mode: '0600'
  delegate_to: localhost
  run_once: true

- name: Read SSH public key
  ansible.builtin.slurp:
    src: "{{ ssh_key_path }}.pub"
  delegate_to: localhost
  register: ssh_public_key_content
  run_once: true

- name: Set SSH public key fact
  ansible.builtin.set_fact:
    ssh_public_key: "{{ ssh_public_key_content.content | b64decode | trim }}"
