# DHCP configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY

config dnsmasq
	option domainneeded '1'
	option boguspriv '1'
	option filterwin2k '0'
	option localise_queries '1'
	option rebind_protection '1'
	option rebind_localhost '1'
	option local '/lan/'
	option domain 'lan'
	option expandhosts '1'
	option nonegcache '0'
	option cachesize '1000'
	option authoritative '1'
	option readethers '1'
	option leasefile '/tmp/dhcp.leases'
	option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto'
	option nonwildcard '1'
	option localservice '1'
	option ednspacket_max '1232'

config dhcp 'lan'
	option interface 'lan'
	option start '{{ dhcp_pools[inventory_hostname].start }}'
	option limit '{{ dhcp_pools[inventory_hostname].limit }}'
	option leasetime '{{ dhcp_leasetime }}'
	option dhcpv4 'server'
	option dhcpv6 'server'
	option ra 'server'
	list ra_flags 'managed-config'
	list ra_flags 'other-config'
	# Provide all nodes as DNS servers for redundancy
	list dhcp_option '6,10.11.12.1,10.11.12.2,10.11.12.3'

config dhcp 'wan'
	option interface 'wan'
	option ignore '1'

# IoT/Infrastructure Network DHCP (LAN2 - 10.11.30.0/24)
config dhcp 'iot'
	option interface 'iot'
	option start '{{ iot_dhcp_start }}'
	option limit '{{ iot_dhcp_limit }}'
	option leasetime '{{ dhcp_leasetime }}'
	option dhcpv4 'server'
	# IoT devices get IoT gateway as DNS
	list dhcp_option '6,{{ iot_gateway }}'
	list dhcp_option '3,{{ iot_gateway }}'

config odhcpd 'odhcpd'
	option maindhcp '0'
	option leasefile '/tmp/hosts/odhcpd'
	option leasetrigger '/usr/sbin/odhcpd-update'
	option loglevel '4'

{% if static_hosts|length > 0 %}
# Static Host Reservations (configured on all nodes for consistency)
{% for host in static_hosts %}
config host
	option name '{{ host.name }}'
	option mac '{{ host.mac }}'
	option ip '{{ host.ip }}'
{% if host.dns is defined %}
	option dns '{{ host.dns }}'
{% endif %}

{% endfor %}
{% endif %}

{% if enable_vlans %}
# VLAN DHCP Configurations (all nodes provide DHCP for redundancy)
{% for vlan_name, vlan_config in vlans.items() %}
{% set vlan_ip = vlan_config.network.split('/')[0] %}
{% set vlan_octets = vlan_ip.split('.') %}
{% set node_octets = node_ip.split('.') %}
config dhcp '{{ vlan_name }}'
	option interface '{{ vlan_name }}_bridge'
	option start '{{ vlan_config.dhcp_start }}'
	option limit '{{ vlan_config.dhcp_limit }}'
	option leasetime '{{ dhcp_leasetime }}'
	option dhcpv4 'server'
	# Provide all nodes as DNS servers for redundancy
	list dhcp_option '6,{{ vlan_octets[0] }}.{{ vlan_octets[1] }}.{{ vlan_octets[2] }}.1,{{ vlan_octets[0] }}.{{ vlan_octets[1] }}.{{ vlan_octets[2] }}.2,{{ vlan_octets[0] }}.{{ vlan_octets[1] }}.{{ vlan_octets[2] }}.3'
	# Gateway: this node's IP in the VLAN subnet
	list dhcp_option '3,{{ vlan_octets[0] }}.{{ vlan_octets[1] }}.{{ vlan_octets[2] }}.{{ node_octets[3] }}'

{% endfor %}
{% endif %}
