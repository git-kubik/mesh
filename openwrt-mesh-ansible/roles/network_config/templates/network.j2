# Network configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# Architecture: Dual-switch aggregation with VLAN separation
# - LAN1: Client devices (bridged to bat0)
# - LAN2: IoT/Infrastructure (isolated, internet-only)
# - LAN3: Switch A trunk (mesh VLAN {{ switch_mesh_vlan }}, client VLAN {{ switch_client_vlan }})
# - LAN4: Switch B trunk (mesh VLAN {{ switch_mesh_vlan }}, client VLAN {{ switch_client_vlan }})

config interface 'loopback'
	option device 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix 'fd12:3456:789a::/48'

# ============================================================================
# WAN Interface
# ============================================================================

config interface 'wan'
	option device 'wan'
	option proto 'dhcp'
	option peerdns '0'
{% for dns in dns_servers %}
	list dns '{{ dns }}'
{% endfor %}

config interface 'wan6'
	option device 'wan'
	option proto 'dhcpv6'

# ============================================================================
# Batman-adv Main Interface
# ============================================================================

config interface 'bat0'
	option proto 'batadv'
	option routing_algo '{{ batman_routing_algo }}'
	option gw_mode 'server'
	option gw_bandwidth '{{ batman_gw_bandwidth }}'
	option distributed_arp_table '1'
	option bridge_loop_avoidance '1'
	option multicast_mode '1'
	option fragmentation '1'
	option hop_penalty '{{ batman_hop_penalty }}'
	option orig_interval '{{ batman_orig_interval }}'

# ============================================================================
# Physical Devices
# ============================================================================

# Physical device for LAN1 (client access)
config device 'lan1_dev'
	option name 'lan1'

# Physical device for LAN2 (IoT/infrastructure)
config device 'lan2_dev'
	option name 'lan2'

# Physical device for LAN3 (Switch A trunk)
config device 'lan3_dev'
	option name 'lan3'

# Physical device for LAN4 (Switch B trunk)
config device 'lan4_dev'
	option name 'lan4'

# ============================================================================
# VLAN Devices for Switch Trunks
# ============================================================================

# VLAN {{ switch_mesh_vlan }} - Mesh Backbone (LAN3 to Switch A)
config device 'lan3_mesh'
	option name 'lan3.{{ switch_mesh_vlan }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# VLAN {{ switch_mesh_vlan }} - Mesh Backbone (LAN4 to Switch B)
config device 'lan4_mesh'
	option name 'lan4.{{ switch_mesh_vlan }}'
	option type '8021q'
	option ifname 'lan4'
	option vid '{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# VLAN {{ switch_client_vlan }} - Client Traffic (LAN3 to Switch A)
config device 'lan3_client'
	option name 'lan3.{{ switch_client_vlan }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ switch_client_vlan }}'

# VLAN {{ switch_client_vlan }} - Client Traffic (LAN4 to Switch B)
config device 'lan4_client'
	option name 'lan4.{{ switch_client_vlan }}'
	option type '8021q'
	option ifname 'lan4'
	option vid '{{ switch_client_vlan }}'

# ============================================================================
# Batman-adv Hard Interfaces (Mesh Backbone)
# ============================================================================

# Wired mesh interface - LAN3 via Switch A (VLAN {{ switch_mesh_vlan }})
config interface 'bat0_hardif_lan3'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'lan3.{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# Wired mesh interface - LAN4 via Switch B (VLAN {{ switch_mesh_vlan }})
config interface 'bat0_hardif_lan4'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'lan4.{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# Wireless mesh interface - 2.4GHz backup
config interface 'bat0_hardif_mesh0'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'phy0-mesh0'
	option mtu '{{ mtu_wireless_mesh }}'

# ============================================================================
# LAN Bridge (Client Network - 10.11.12.0/24)
# ============================================================================

# LAN Bridge device
# Includes: bat0, lan1 (direct clients), switch client VLANs
config device 'br_lan'
	option name 'br-lan'
	option type 'bridge'
	list ports 'bat0'
	list ports 'lan1'
	list ports 'lan3.{{ switch_client_vlan }}'
	list ports 'lan4.{{ switch_client_vlan }}'

# LAN interface configuration
config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '{{ node_ip }}'
	option netmask '{{ mesh_netmask }}'
	option ip6assign '60'
	# DNS provided by local dnsmasq on each node
	list dns '127.0.0.1'

# ============================================================================
# IoT/Infrastructure Network (VLAN {{ iot_vlan }} - 10.11.30.0/24)
# ============================================================================

# IoT Bridge device (LAN2 only - not bridged to mesh)
config device 'br_iot'
	option name 'br-iot'
	option type 'bridge'
	list ports 'lan2'

# IoT interface configuration
config interface 'iot'
	option device 'br-iot'
	option proto 'static'
	option ipaddr '{{ iot_gateway }}'
	option netmask '{{ iot_netmask }}'

{% if enable_vlans %}
# ============================================================================
# Optional VLAN Configurations (Management, Guest WiFi)
# ============================================================================
{% for vlan_name, vlan_config in vlans.items() %}
{% if vlan_name not in ['iot'] %}

config interface '{{ vlan_name }}'
	option proto 'batadv_vlan'
	option master 'bat0'
	option vid '{{ vlan_config.vid }}'
{% if vlan_config.isolation is defined and vlan_config.isolation %}
	option ap_isolation '1'
{% else %}
	option ap_isolation '0'
{% endif %}

config interface '{{ vlan_name }}_bridge'
	option proto 'static'
	option type 'bridge'
	list ports '{{ vlan_name }}'
	option ipaddr '{{ vlan_config.gateway_ip }}'
	option netmask '{{ vlan_config.netmask }}'
{% endif %}
{% endfor %}
{% endif %}
