# Network configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# Architecture: Batman-adv mesh with full switch integration (HA design)
# - LAN1: Client devices (bridged to bat0)
# - LAN2: IoT/Infrastructure (bridged to bat0.{{ iot_vlan }})
# - LAN3: Switch A trunk - ALL VLANs ({{ switch_mesh_vlan }}, {{ switch_client_vlan }}, {{ vlans.management.vid }}, {{ iot_vlan }})
# - LAN4: Switch C trunk - Mesh + Mgmt ({{ switch_mesh_vlan }}, {{ vlans.management.vid }})
#
# LOOP PREVENTION: Batman-adv Bridge Loop Avoidance (BLA) detects and prevents L2 loops
# when frames arrive via both mesh (bat0) and switch ports (lan3/lan4). BLA must be
# enabled (bridge_loop_avoidance = 1) for this to work.
#
# HIGH AVAILABILITY: All nodes bridge switch VLANs. If any node fails, traffic
# automatically flows through remaining nodes. No single point of failure.
#
# CRITICAL: Node interfaces MUST use static IPs (proto='static'), NOT DHCP.
# BLA does not protect node-originated traffic - DHCP requests would cause storms.

config interface 'loopback'
	option device 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix 'fd12:3456:789a::/48'

# ============================================================================
# WAN Interface
# ============================================================================

config interface 'wan'
	option device 'wan'
	option proto 'dhcp'
	option peerdns '0'
{% for dns in dns_servers %}
	list dns '{{ dns }}'
{% endfor %}

config interface 'wan6'
	option device 'wan'
	option proto 'dhcpv6'

# ============================================================================
# Batman-adv Main Interface
# ============================================================================
# Gateway mode: server (has WAN) or client (no WAN)
# Nodes with has_wan=true advertise themselves as gateways
# Nodes with has_wan=false route through gateway nodes

config interface 'bat0'
	option proto 'batadv'
	option routing_algo '{{ batman_routing_algo }}'
{% if has_wan | default(true) %}
	option gw_mode 'server'
	option gw_bandwidth '{{ batman_gw_bandwidth }}'
{% else %}
	option gw_mode 'client'
	# gw_sel_class: prefer higher bandwidth gateways
	option gw_sel_class '20'
{% endif %}
	option distributed_arp_table '1'
	option bridge_loop_avoidance '1'
	option multicast_mode '1'
	option fragmentation '1'
	option hop_penalty '{{ batman_hop_penalty }}'
	option orig_interval '{{ batman_orig_interval }}'

# ============================================================================
# Physical Devices
# ============================================================================

# Physical device for LAN1 (client access)
config device 'lan1_dev'
	option name 'lan1'

# Physical device for LAN2 (IoT/infrastructure)
config device 'lan2_dev'
	option name 'lan2'

# Physical device for LAN3 (Switch A trunk)
config device 'lan3_dev'
	option name 'lan3'

# Physical device for LAN4 (Switch B trunk)
config device 'lan4_dev'
	option name 'lan4'

# ============================================================================
# VLAN Devices for Switch Trunks
# ============================================================================

# VLAN {{ switch_mesh_vlan }} - Mesh Backbone (LAN3 to Switch A)
config device 'lan3_mesh'
	option name 'lan3.{{ switch_mesh_vlan }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# VLAN {{ switch_mesh_vlan }} - Mesh Backbone (LAN4 to Switch C)
config device 'lan4_mesh'
	option name 'lan4.{{ switch_mesh_vlan }}'
	option type '8021q'
	option ifname 'lan4'
	option vid '{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# NOTE: No lan4 user VLANs defined - Switch C carries ONLY mesh backbone (VLAN 100)
# This prevents L2 loops. User VLANs (10, 30, 200) go through Switch A (lan3) only.

# VLAN {{ switch_client_vlan }} - Client Traffic (LAN3 to Switch A only)
config device 'lan3_client'
	option name 'lan3.{{ switch_client_vlan }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ switch_client_vlan }}'

# VLAN {{ vlans.management.vid }} - Management (LAN3 to Switch A only)
config device 'lan3_mgmt'
	option name 'lan3.{{ vlans.management.vid }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ vlans.management.vid }}'

# VLAN {{ iot_vlan }} - IoT (LAN3 to Switch A only)
config device 'lan3_iot'
	option name 'lan3.{{ iot_vlan }}'
	option type '8021q'
	option ifname 'lan3'
	option vid '{{ iot_vlan }}'

# IoT VLAN device on Batman mesh (802.1q VLAN on bat0)
# This enables IoT traffic to flow through the wireless mesh as backup
config device 'bat0_iot'
	option name 'bat0.{{ iot_vlan }}'
	option type '8021q'
	option ifname 'bat0'
	option vid '{{ iot_vlan }}'

# ============================================================================
# Batman-adv Hard Interfaces (Mesh Backbone)
# ============================================================================

# Wired mesh interface - LAN3 via Switch A (VLAN {{ switch_mesh_vlan }})
config interface 'bat0_hardif_lan3'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'lan3.{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# Wired mesh interface - LAN4 via Switch B (VLAN {{ switch_mesh_vlan }})
config interface 'bat0_hardif_lan4'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'lan4.{{ switch_mesh_vlan }}'
	option mtu '{{ mtu_wired_mesh }}'

# Wireless mesh interface - 2.4GHz backup
config interface 'bat0_hardif_mesh0'
	option proto 'batadv_hardif'
	option master 'bat0'
	option device 'phy0-mesh0'
	option mtu '{{ mtu_wireless_mesh }}'

# ============================================================================
# LAN Bridge (Client Network - 10.11.12.0/24)
# ============================================================================

# LAN Bridge device
# Includes: bat0 (mesh), lan1 (direct clients), Switch A client VLAN
# BLA prevents loops when same frame arrives via bat0 and lan3.X
config device 'br_lan'
	option name 'br-lan'
	option type 'bridge'
	list ports 'bat0'
	list ports 'lan1'
	list ports 'lan3.{{ switch_client_vlan }}'

# LAN interface configuration
config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '{{ node_ip }}'
	option netmask '{{ mesh_netmask }}'
	option ip6assign '60'
	# DNS provided by local dnsmasq on each node
	list dns '127.0.0.1'

# ============================================================================
# IoT/Infrastructure Network (VLAN {{ iot_vlan }} - 10.11.30.0/24)
# ============================================================================

# IoT interface configuration
# Bridge includes: LAN2 (direct), bat0 VLAN (mesh), Switch A IoT VLAN
# WiFi interface added via wireless config
# BLA prevents loops when same frame arrives via bat0.X and lan3.X
# Each node gets its own IP: 10.11.30.{node_number} based on node_ip last octet
{% set iot_network_octets = iot_network.split('.') %}
{% set iot_node_octet = node_ip.split('.')[3] %}
config interface 'iot'
	option proto 'static'
	option type 'bridge'
	list ports 'bat0.{{ iot_vlan }}'
	list ports 'lan2'
	list ports 'lan3.{{ iot_vlan }}'
	option ipaddr '{{ iot_network_octets[0] }}.{{ iot_network_octets[1] }}.{{ iot_network_octets[2] }}.{{ iot_node_octet }}'
	option netmask '{{ iot_netmask }}'

{% if enable_vlans %}
# ============================================================================
# Optional VLAN Configurations (Management, Guest WiFi)
# ============================================================================

# Management VLAN device on Batman mesh (802.1q VLAN on bat0)
# This enables management traffic to flow through the wireless mesh
config device 'bat0_mgmt'
	option name 'bat0.{{ vlans.management.vid }}'
	option type '8021q'
	option ifname 'bat0'
	option vid '{{ vlans.management.vid }}'

# Guest VLAN device on Batman mesh (802.1q VLAN on bat0)
config device 'bat0_guest'
	option name 'bat0.{{ vlans.guest.vid }}'
	option type '8021q'
	option ifname 'bat0'
	option vid '{{ vlans.guest.vid }}'

# Management Network Bridge (br-mgmt, max 15 char limit)
# Includes: Batman VLAN (mesh), Switch A mgmt VLAN
# WiFi interface added via wireless config
# BLA prevents loops when same frame arrives via bat0.X and lan3.X
# NOTE: lan4.X (Switch C) NOT bridged - only carries mesh backbone, not mgmt VLAN to bridge
# Each node gets its own IP: 10.11.10.{node_number} based on node_ip last octet
{% set mgmt_network = vlans.management.network.split('/')[0].split('.') %}
{% set node_octet = node_ip.split('.')[3] %}
config interface 'mgmt'
	option proto 'static'
	option type 'bridge'
	option bridge_empty '1'
	list ports 'bat0.{{ vlans.management.vid }}'
	list ports 'lan3.{{ vlans.management.vid }}'
	option ipaddr '{{ mgmt_network[0] }}.{{ mgmt_network[1] }}.{{ mgmt_network[2] }}.{{ node_octet }}'
	option netmask '{{ vlans.management.netmask }}'

# Guest Network Bridge
# Isolated guest network via Batman mesh VLAN
# Each node gets its own IP: 10.11.20.{node_number} based on node_ip last octet
{% set guest_network = vlans.guest.network.split('/')[0].split('.') %}
config interface 'guest_bridge'
	option proto 'static'
	option type 'bridge'
	option bridge_empty '1'
	list ports 'bat0.{{ vlans.guest.vid }}'
	option ipaddr '{{ guest_network[0] }}.{{ guest_network[1] }}.{{ guest_network[2] }}.{{ node_octet }}'
	option netmask '{{ vlans.guest.netmask }}'
{% endif %}
