#!/bin/sh
# Batman-adv per-interface hop penalty configuration
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# This hotplug script sets different hop penalties for wired vs wireless
# mesh interfaces to prevent route flapping in hybrid networks.
#
# Wired interfaces (LAN3/LAN4): Low penalty ({{ batman_hop_penalty_wired }}) - prefer wired
# Wireless interface (mesh0): High penalty ({{ batman_hop_penalty_wireless }}) - backup only

[ "$ACTION" = "ifup" ] || exit 0

# Only run for batman-adv interfaces
case "$INTERFACE" in
    bat0_hardif_*)
        ;;
    *)
        exit 0
        ;;
esac

# Wait for interface to be fully up
sleep 1

# Determine interface type and set appropriate hop penalty
case "$INTERFACE" in
    bat0_hardif_lan3|bat0_hardif_lan4)
        # Wired mesh interfaces - low hop penalty (prefer)
        PENALTY={{ batman_hop_penalty_wired }}
        DEVICE=$(uci -q get network.$INTERFACE.device)
        ;;
    bat0_hardif_mesh0)
        # Wireless mesh interface - high hop penalty (backup)
        PENALTY={{ batman_hop_penalty_wireless }}
        DEVICE="phy0-mesh0"
        ;;
    *)
        exit 0
        ;;
esac

# Apply hop penalty if device exists
if [ -n "$DEVICE" ] && [ -d "/sys/class/net/$DEVICE" ]; then
    # Use batctl to set per-interface hop penalty
    batctl hardif "$DEVICE" hop_penalty "$PENALTY" 2>/dev/null
    logger -t batman-hop-penalty "Set hop_penalty=$PENALTY for $DEVICE ($INTERFACE)"
fi
