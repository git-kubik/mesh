# Firewall configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# Zones:
# - lan: Client network (10.11.12.0/24) - full access
# - iot: IoT/Infrastructure (10.11.30.0/24) - internet only, isolated from LAN
# - wan: Internet uplink - NAT masquerading
# - management/guest: Optional WiFi VLANs

config defaults
	option input 'REJECT'
	option output 'ACCEPT'
	option forward 'REJECT'
	option synflood_protect '1'

# ============================================================================
# Core Zones
# ============================================================================

config zone
	option name 'lan'
	list network 'lan'
	option input 'ACCEPT'
	option output 'ACCEPT'
	option forward 'ACCEPT'

config zone
	option name 'wan'
	list network 'wan'
	list network 'wan6'
	option input 'REJECT'
	option output 'ACCEPT'
	option forward 'REJECT'
	option masq '1'
	option mtu_fix '1'

# IoT Zone (isolated from LAN, limited access to management services)
config zone
	option name 'iot'
	list network 'iot'
	option input 'REJECT'
	option output 'ACCEPT'
	option forward 'REJECT'

# Management Zone (Proxmox, VMs, admin devices)
# Note: This is a static zone - do NOT duplicate in the VLAN loop below
config zone
	option name 'management'
	list network 'mgmt'
	option input 'ACCEPT'
	option output 'ACCEPT'
	option forward 'ACCEPT'

# ============================================================================
# Forwarding Rules
# ============================================================================

# LAN to WAN (full internet access)
config forwarding
	option src 'lan'
	option dest 'wan'

# IoT to WAN (internet access only)
config forwarding
	option src 'iot'
	option dest 'wan'

# Management to WAN (internet access)
config forwarding
	option src 'management'
	option dest 'wan'

# Management to LAN (full access to client network)
config forwarding
	option src 'management'
	option dest 'lan'

# LAN to Management (trusted clients can access management)
config forwarding
	option src 'lan'
	option dest 'management'

# ============================================================================
# IoT Zone Rules
# ============================================================================

# Allow DHCP for IoT devices
config rule
	option name 'Allow-IoT-DHCP'
	option src 'iot'
	option proto 'udp'
	option dest_port '67'
	option target 'ACCEPT'

# Allow DNS for IoT devices
config rule
	option name 'Allow-IoT-DNS'
	option src 'iot'
	option proto 'udp'
	option dest_port '53'
	option target 'ACCEPT'

# Allow DNS TCP for IoT devices (for large responses)
config rule
	option name 'Allow-IoT-DNS-TCP'
	option src 'iot'
	option proto 'tcp'
	option dest_port '53'
	option target 'ACCEPT'

# Allow ICMP (ping) from IoT to router
config rule
	option name 'Allow-IoT-Ping'
	option src 'iot'
	option proto 'icmp'
	option icmp_type 'echo-request'
	option target 'ACCEPT'

# Block IoT access to LAN network
config rule
	option name 'Block-IoT-to-LAN'
	option src 'iot'
	option dest 'lan'
	option target 'REJECT'

# ============================================================================
# IoT to Management Rules (Selective Access)
# ============================================================================
# Allow IoT devices to reach specific services on Management network
# All other IoT → Management traffic is blocked

# Allow IoT → MQTT Broker (port 1883)
config rule
	option name 'Allow-IoT-MQTT'
	option src 'iot'
	option dest 'management'
	option proto 'tcp'
	option dest_port '1883'
	option target 'ACCEPT'

# Allow IoT → MQTT TLS (port 8883)
config rule
	option name 'Allow-IoT-MQTT-TLS'
	option src 'iot'
	option dest 'management'
	option proto 'tcp'
	option dest_port '8883'
	option target 'ACCEPT'

# Allow IoT → Home Assistant API (port 8123)
config rule
	option name 'Allow-IoT-HomeAssistant'
	option src 'iot'
	option dest 'management'
	option proto 'tcp'
	option dest_port '8123'
	option target 'ACCEPT'

# Allow IoT → Home Assistant HTTPS (port 8443)
config rule
	option name 'Allow-IoT-HomeAssistant-TLS'
	option src 'iot'
	option dest 'management'
	option proto 'tcp'
	option dest_port '8443'
	option target 'ACCEPT'

# Block all other IoT → Management traffic
config rule
	option name 'Block-IoT-to-Management'
	option src 'iot'
	option dest 'management'
	option target 'REJECT'

# ============================================================================
# WAN Input Rules
# ============================================================================

# Allow DHCP Renew
config rule
	option name 'Allow-DHCP-Renew'
	option src 'wan'
	option proto 'udp'
	option dest_port '68'
	option target 'ACCEPT'
	option family 'ipv4'

# Allow Ping
config rule
	option name 'Allow-Ping'
	option src 'wan'
	option proto 'icmp'
	option icmp_type 'echo-request'
	option family 'ipv4'
	option target 'ACCEPT'

# Allow IGMP
config rule
	option name 'Allow-IGMP'
	option src 'wan'
	option proto 'igmp'
	option family 'ipv4'
	option target 'ACCEPT'

# Allow DHCPv6
config rule
	option name 'Allow-DHCPv6'
	option src 'wan'
	option proto 'udp'
	option dest_port '546'
	option family 'ipv6'
	option target 'ACCEPT'

# Allow MLD
config rule
	option name 'Allow-MLD'
	option src 'wan'
	option proto 'icmp'
	option src_ip 'fe80::/10'
	list icmp_type '130/0'
	list icmp_type '131/0'
	list icmp_type '132/0'
	list icmp_type '143/0'
	option family 'ipv6'
	option target 'ACCEPT'

# Allow ICMPv6 Input
config rule
	option name 'Allow-ICMPv6-Input'
	option src 'wan'
	option proto 'icmp'
	list icmp_type 'echo-request'
	list icmp_type 'echo-reply'
	list icmp_type 'destination-unreachable'
	list icmp_type 'packet-too-big'
	list icmp_type 'time-exceeded'
	list icmp_type 'bad-header'
	list icmp_type 'unknown-header-type'
	list icmp_type 'router-solicitation'
	list icmp_type 'neighbour-solicitation'
	list icmp_type 'router-advertisement'
	list icmp_type 'neighbour-advertisement'
	option limit '1000/sec'
	option family 'ipv6'
	option target 'ACCEPT'

# Allow ICMPv6 Forward
config rule
	option name 'Allow-ICMPv6-Forward'
	option src 'wan'
	option dest '*'
	option proto 'icmp'
	list icmp_type 'echo-request'
	list icmp_type 'echo-reply'
	list icmp_type 'destination-unreachable'
	list icmp_type 'packet-too-big'
	list icmp_type 'time-exceeded'
	list icmp_type 'bad-header'
	list icmp_type 'unknown-header-type'
	option limit '1000/sec'
	option family 'ipv6'
	option target 'ACCEPT'

# Allow IPSec ESP
config rule
	option name 'Allow-IPSec-ESP'
	option src 'wan'
	option dest 'lan'
	option proto 'esp'
	option target 'ACCEPT'

# Allow ISAKMP
config rule
	option name 'Allow-ISAKMP'
	option src 'wan'
	option dest 'lan'
	option dest_port '500'
	option proto 'udp'
	option target 'ACCEPT'

{% if enable_vlans %}
# ============================================================================
# Optional VLAN Zones (Guest WiFi - management zone is defined above)
# ============================================================================
{% for vlan_name, vlan_config in vlans.items() %}
{% if vlan_name != 'management' %}

config zone
	option name '{{ vlan_name }}'
	list network '{{ vlan_name }}_bridge'
{% if vlan_config.isolation is defined and vlan_config.isolation %}
	option input 'REJECT'
{% else %}
	option input 'ACCEPT'
{% endif %}
	option output 'ACCEPT'
	option forward 'REJECT'

config forwarding
	option src '{{ vlan_name }}'
	option dest 'wan'

{% if vlan_config.isolation is defined and vlan_config.isolation %}
# Allow DHCP/DNS for isolated {{ vlan_name }} network
config rule
	option name 'Allow-{{ vlan_name }}-DHCP-DNS'
	option src '{{ vlan_name }}'
	option proto 'udp'
	list dest_port '53'
	list dest_port '67'
	option target 'ACCEPT'

# Block {{ vlan_name }} access to LAN (all protocols including ICMP)
config rule
	option name 'Block-{{ vlan_name }}-to-LAN'
	option src '{{ vlan_name }}'
	option dest 'lan'
	option proto 'all'
	option target 'REJECT'

# Block {{ vlan_name }} access to IoT (all protocols including ICMP)
config rule
	option name 'Block-{{ vlan_name }}-to-IoT'
	option src '{{ vlan_name }}'
	option dest 'iot'
	option proto 'all'
	option target 'REJECT'

# Block {{ vlan_name }} access to Management (all protocols)
config rule
	option name 'Block-{{ vlan_name }}-to-Management'
	option src '{{ vlan_name }}'
	option dest 'management'
	option proto 'all'
	option target 'REJECT'

{% endif %}
{% endif %}
{% endfor %}
{% endif %}
