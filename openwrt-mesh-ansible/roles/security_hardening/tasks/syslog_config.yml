---
# Security Hardening - Security Logging Configuration
#
# Configures syslog for security event logging:
# - Local logging of auth failures, firewall events, SSH connections
# - Preparation for future remote syslog integration

- name: Syslog - Configure system logging level
  ansible.builtin.raw: |
    # Set log level for security events
    uci set system.@system[0].log_size='128'
    uci set system.@system[0].log_buffer_size='64'
    uci set system.@system[0].conloglevel='{{ security_syslog_level }}'
    uci set system.@system[0].cronloglevel='{{ security_syslog_level }}'
    uci commit system
    echo "System logging configured"
  register: syslog_config
  changed_when: "'configured' in syslog_config.stdout"

- name: Syslog - Enable logging of firewall drops
  ansible.builtin.raw: |
    # Enable logging for dropped packets in firewall zones
    for zone in $(uci show firewall | grep "=zone" | cut -d'=' -f1); do
      zone_name=$(uci get "${zone}.name" 2>/dev/null)
      if [ "$zone_name" = "wan" ] || [ "$zone_name" = "iot" ] || [ "$zone_name" = "guest" ]; then
        uci set "${zone}.log"='1'
        uci set "${zone}.log_limit"='10/minute'
      fi
    done
    uci commit firewall
    echo "Firewall logging enabled"
  register: fw_logging
  changed_when: "'enabled' in fw_logging.stdout"
  # No notify - reboot at end of deployment applies changes

- name: Syslog - Configure remote syslog (if enabled)
  ansible.builtin.raw: |
    {% if security_syslog_remote_enabled | bool and security_syslog_server %}
    # Configure remote syslog server
    uci set system.@system[0].log_ip='{{ security_syslog_server.split(":")[0] }}'
    uci set system.@system[0].log_port='{{ security_syslog_server.split(":")[1] | default("514") }}'
    uci set system.@system[0].log_proto='udp'
    uci commit system
    echo "Remote syslog configured: {{ security_syslog_server }}"
    {% else %}
    echo "Remote syslog not enabled"
    {% endif %}
  register: remote_syslog
  changed_when: "'configured' in remote_syslog.stdout"

- name: Syslog - Create security event monitoring script
  ansible.builtin.raw: |
    cat > /usr/sbin/security-monitor.sh << 'SCRIPT'
    #!/bin/sh
    # Security Event Monitor - Generated by Ansible
    # Monitors syslog for security-relevant events

    LOG_FILE="/tmp/security-events.log"

    # Monitor for security events
    logread -f | while read line; do
      case "$line" in
        *"Failed password"*|*"authentication failure"*)
          echo "$(date '+%Y-%m-%d %H:%M:%S') AUTH_FAIL: $line" >> "$LOG_FILE"
          ;;
        *"Accepted publickey"*|*"Accepted password"*)
          echo "$(date '+%Y-%m-%d %H:%M:%S') AUTH_OK: $line" >> "$LOG_FILE"
          ;;
        *"DROP"*|*"REJECT"*)
          echo "$(date '+%Y-%m-%d %H:%M:%S') FW_DROP: $line" >> "$LOG_FILE"
          ;;
        *"session opened"*|*"session closed"*)
          echo "$(date '+%Y-%m-%d %H:%M:%S') SESSION: $line" >> "$LOG_FILE"
          ;;
      esac
    done
    SCRIPT
    chmod +x /usr/sbin/security-monitor.sh
    echo "Security monitor script created"
  register: monitor_script
  changed_when: "'created' in monitor_script.stdout"

- name: Syslog - Display configuration summary
  ansible.builtin.debug:
    msg: |
      Security Logging Configuration:
        - Log Size: 128KB
        - Buffer Size: 64KB
        - Log Level: {{ security_syslog_level }}
        - Firewall Drop Logging: Enabled (10/minute limit)
        - Remote Syslog: {{ 'Enabled (' + security_syslog_server + ')' if security_syslog_remote_enabled | bool else 'Disabled (future feature)' }}
        - Security Monitor: /usr/sbin/security-monitor.sh
