---
# Security Hardening - Rate Limiting
#
# Adds iptables rules to prevent brute force attacks and flooding:
# - SSH connection rate limiting
# - ICMP rate limiting
# - New connection rate limiting

- name: Rate Limiting - Add SSH brute force protection
  ansible.builtin.raw: |
    # Check if rule already exists
    if iptables -C INPUT -p tcp --dport 22 -m state --state NEW -m recent --name SSH --set 2>/dev/null; then
      echo "SSH rate limit rules already exist"
    else
      # Create SSH rate limiting chain
      iptables -N SSH_RATE_LIMIT 2>/dev/null || true

      # Track new SSH connections
      iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name SSH --set

      # Drop if more than N connections per minute from same IP
      iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --name SSH --update --seconds 60 --hitcount {{ security_rate_limit_ssh_per_minute | int + 1 }} -j DROP

      echo "SSH rate limit rules added"
    fi
  register: ssh_rate_limit
  changed_when: "'rules added' in ssh_rate_limit.stdout"

- name: Rate Limiting - Add ICMP flood protection
  ansible.builtin.raw: |
    # Check if ICMP rate limit exists
    if iptables -C INPUT -p icmp --icmp-type echo-request -m limit --limit {{ security_rate_limit_icmp_per_second }}/second --limit-burst 20 -j ACCEPT 2>/dev/null; then
      echo "ICMP rate limit rules already exist"
    else
      # Allow ICMP with rate limiting
      iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit {{ security_rate_limit_icmp_per_second }}/second --limit-burst 20 -j ACCEPT

      # Drop excess ICMP
      iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

      echo "ICMP rate limit rules added"
    fi
  register: icmp_rate_limit
  changed_when: "'rules added' in icmp_rate_limit.stdout"

- name: Rate Limiting - Save iptables rules to firewall config
  ansible.builtin.raw: |
    # Create custom firewall include file for rate limiting rules
    cat > /etc/firewall.rate_limit << 'EOF'
    # Rate Limiting Rules - Generated by Ansible security_hardening role
    # SSH brute force protection
    iptables -N SSH_RATE_LIMIT 2>/dev/null
    iptables -F SSH_RATE_LIMIT 2>/dev/null
    iptables -A SSH_RATE_LIMIT -m recent --name SSH --set
    iptables -A SSH_RATE_LIMIT -m recent --name SSH --update --seconds 60 --hitcount {{ security_rate_limit_ssh_per_minute | int + 1 }} -j DROP
    iptables -A SSH_RATE_LIMIT -j ACCEPT

    # Apply to SSH traffic (insert at beginning of INPUT)
    iptables -D INPUT -p tcp --dport 22 -m state --state NEW -j SSH_RATE_LIMIT 2>/dev/null
    iptables -I INPUT -p tcp --dport 22 -m state --state NEW -j SSH_RATE_LIMIT

    # ICMP rate limiting
    iptables -D INPUT -p icmp --icmp-type echo-request -m limit --limit {{ security_rate_limit_icmp_per_second }}/second --limit-burst 20 -j ACCEPT 2>/dev/null
    iptables -I INPUT -p icmp --icmp-type echo-request -m limit --limit {{ security_rate_limit_icmp_per_second }}/second --limit-burst 20 -j ACCEPT
    EOF
    chmod +x /etc/firewall.rate_limit

    # Add to firewall includes if not already present
    if ! uci show firewall | grep -q "firewall.rate_limit"; then
      uci add firewall include
      uci set firewall.@include[-1].path='/etc/firewall.rate_limit'
      uci set firewall.@include[-1].reload='1'
      uci commit firewall
      echo "Rate limiting rules added to firewall includes"
    else
      echo "Rate limiting already in firewall includes"
    fi
  register: fw_include
  changed_when: "'added to firewall' in fw_include.stdout"

- name: Rate Limiting - Display configuration summary
  ansible.builtin.debug:
    msg: |
      Rate Limiting Configuration:
        - SSH: Max {{ security_rate_limit_ssh_per_minute }} new connections/minute per IP
        - ICMP: Max {{ security_rate_limit_icmp_per_second }} pings/second (burst 20)
        - Rules saved to: /etc/firewall.rate_limit
