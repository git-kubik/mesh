---
# Factory Reset Playbook - Reset configured mesh node to vanilla OpenWrt
#
# This playbook:
#   1. Connects to a fully configured mesh node (10.11.12.x)
#   2. Uploads the vanilla OpenWrt sysupgrade image
#   3. Performs sysupgrade with -n flag (do not preserve config)
#   4. Node reboots to factory defaults (192.168.1.1)
#
# Usage:
#   make factory-reset NODE=1
#   make factory-reset NODE=3
#
# Or directly:
#   ansible-playbook -i inventory/hosts.yml playbooks/factory-reset.yml --limit node3
#
# After reset:
#   - Node IP will be 192.168.1.1
#   - SSH: root@192.168.1.1 (no password, dropbear)
#   - Ready for fresh deployment with: make deploy NODE=X
#
# WARNING: This will ERASE ALL CONFIGURATION on the target node!

- name: Factory Reset - Restore Vanilla OpenWrt
  hosts: mesh_nodes
  gather_facts: false

  vars:
    openwrt_version: "{{ lookup('env', 'OPENWRT_VERSION') | default('24.10.4', true) }}"
    vanilla_image: "{{ playbook_dir }}/../openwrt-repo/targets/ramips/mt7621/openwrt-{{ openwrt_version }}-ramips-mt7621-dlink_dir-1960-a1-squashfs-sysupgrade.bin"
    remote_image_path: "/tmp/sysupgrade.bin"

  tasks:
    ###########################################################################
    # Phase 1: Pre-flight Checks
    ###########################################################################

    - name: Check vanilla image exists locally
      delegate_to: localhost
      stat:
        path: "{{ vanilla_image }}"
      register: image_stat
      failed_when: not image_stat.stat.exists
      tags: [check]

    - name: Display image info
      delegate_to: localhost
      debug:
        msg: "Using vanilla image: {{ vanilla_image }} ({{ (image_stat.stat.size / 1024 / 1024) | round(2) }} MB)"
      tags: [check]

    - name: Wait for SSH to be available
      raw: echo "SSH connection successful"
      register: ssh_test
      retries: 5
      delay: 5
      until: ssh_test is success
      changed_when: false
      tags: [check]

    - name: Get current hostname
      raw: uci -q get system.@system[0].hostname || cat /proc/sys/kernel/hostname
      register: current_hostname
      changed_when: false
      tags: [check]

    - name: Get current IP configuration
      raw: ip addr show br-lan | grep "inet " | awk '{print $2}'
      register: current_ip
      changed_when: false
      tags: [check]

    - name: Display current node info
      debug:
        msg: |
          Target Node: {{ current_hostname.stdout | trim }}
          Current IP: {{ current_ip.stdout | trim }}
          Ansible Host: {{ ansible_host }}
      tags: [check]

    ###########################################################################
    # Phase 2: Safety Confirmation
    ###########################################################################

    - name: Display factory reset warning
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                    ⚠️  FACTORY RESET WARNING ⚠️                    ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║  This will ERASE ALL CONFIGURATION on:                           ║
          ║                                                                  ║
          ║    Hostname: {{ current_hostname.stdout | trim | center(46) }}   ║
          ║    IP: {{ ansible_host | center(52) }}                           ║
          ║                                                                  ║
          ║  After reset:                                                    ║
          ║    - Node will reboot to 192.168.1.1                            ║
          ║    - All mesh config will be LOST                               ║
          ║    - SSH key authentication will be REMOVED                     ║
          ║    - Root password will be CLEARED                              ║
          ║                                                                  ║
          ╚══════════════════════════════════════════════════════════════════╝
      tags: [confirm]

    ###########################################################################
    # Phase 3: Check Available Space
    ###########################################################################

    - name: Check available space in /tmp
      raw: df /tmp | tail -1 | awk '{print $4}'
      register: tmp_space
      changed_when: false
      tags: [check]

    - name: Verify sufficient space for upload
      fail:
        msg: "Insufficient space in /tmp. Need ~15MB, have {{ (tmp_space.stdout | int / 1024) | round(1) }}MB"
      when: (tmp_space.stdout | int) < 15000
      tags: [check]

    ###########################################################################
    # Phase 4: Upload Vanilla Image
    ###########################################################################

    - name: Upload vanilla OpenWrt image to node
      copy:
        src: "{{ vanilla_image }}"
        dest: "{{ remote_image_path }}"
        mode: "0644"
      tags: [upload]

    - name: Verify uploaded image
      raw: ls -la {{ remote_image_path }} && md5sum {{ remote_image_path }}
      register: uploaded_image
      changed_when: false
      tags: [upload]

    - name: Display uploaded image info
      debug:
        msg: "{{ uploaded_image.stdout_lines }}"
      tags: [upload]

    ###########################################################################
    # Phase 5: Perform Factory Reset (sysupgrade -n)
    ###########################################################################

    - name: Display pre-upgrade message
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          STARTING FACTORY RESET
          ═══════════════════════════════════════════════════════════════
          Image: {{ remote_image_path }}
          Command: sysupgrade -n {{ remote_image_path }}

          The -n flag means DO NOT preserve configuration.
          Node will reboot to factory defaults after upgrade.
          ═══════════════════════════════════════════════════════════════
      tags: [upgrade]

    - name: Verify image before sysupgrade
      raw: |
        echo "=== Pre-sysupgrade verification ===" > /tmp/sysupgrade.log
        echo "Date: $(date)" >> /tmp/sysupgrade.log
        echo "Image path: {{ remote_image_path }}" >> /tmp/sysupgrade.log
        ls -la {{ remote_image_path }} >> /tmp/sysupgrade.log 2>&1
        echo "" >> /tmp/sysupgrade.log
        echo "=== Sysupgrade test run ===" >> /tmp/sysupgrade.log
        sysupgrade -T {{ remote_image_path }} >> /tmp/sysupgrade.log 2>&1
        RESULT=$?
        echo "Test result: $RESULT" >> /tmp/sysupgrade.log
        cat /tmp/sysupgrade.log
        exit $RESULT
      register: sysupgrade_test
      changed_when: false
      tags: [upgrade]

    - name: Display sysupgrade test results
      debug:
        msg: "{{ sysupgrade_test.stdout_lines }}"
      tags: [upgrade]

    - name: Execute sysupgrade (factory reset)
      raw: |
        echo "=== Starting sysupgrade ===" >> /tmp/sysupgrade.log
        echo "Command: sysupgrade -v -n {{ remote_image_path }}" >> /tmp/sysupgrade.log
        echo "Time: $(date)" >> /tmp/sysupgrade.log
        # Run sysupgrade with verbose output in background, log it
        sysupgrade -v -n {{ remote_image_path }} >> /tmp/sysupgrade.log 2>&1 &
        SYSUPGRADE_PID=$!
        echo "Sysupgrade PID: $SYSUPGRADE_PID" >> /tmp/sysupgrade.log
        # Wait a moment to capture initial output
        sleep 3
        # Show what we captured
        cat /tmp/sysupgrade.log
      ignore_errors: true
      ignore_unreachable: true
      register: sysupgrade_result
      changed_when: true
      tags: [upgrade]

    - name: Wait for sysupgrade to start
      pause:
        seconds: 5
      tags: [upgrade]

    - name: Check if sysupgrade is running (will fail if node already rebooting)
      raw: pgrep -f sysupgrade || echo "sysupgrade process not found (may have completed)"
      ignore_errors: true
      ignore_unreachable: true
      register: sysupgrade_check
      changed_when: false
      tags: [upgrade]

    - name: Display sysupgrade status
      debug:
        msg: "Sysupgrade check: {{ sysupgrade_check.stdout | default('Node unreachable - sysupgrade in progress') }}"
      ignore_errors: true
      tags: [upgrade]

    ###########################################################################
    # Phase 6: Post-Reset Instructions
    ###########################################################################

    - name: Display post-reset instructions
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║                    ✅ FACTORY RESET INITIATED                     ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║                                                                  ║
          ║  The node is now upgrading and will reboot to factory defaults.  ║
          ║                                                                  ║
          ║  NEXT STEPS:                                                     ║
          ║                                                                  ║
          ║  1. Wait 2-3 minutes for upgrade and reboot to complete         ║
          ║                                                                  ║
          ║  2. Change your workstation network settings:                   ║
          ║     - IP: 192.168.1.50 (or similar in 192.168.1.0/24)          ║
          ║     - Gateway: 192.168.1.1                                      ║
          ║                                                                  ║
          ║  3. Verify node is accessible:                                  ║
          ║     ping 192.168.1.1                                            ║
          ║                                                                  ║
          ║  4. SSH to node (no password required):                         ║
          ║     ssh root@192.168.1.1                                        ║
          ║                                                                  ║
          ║  5. Re-deploy mesh configuration:                               ║
          ║     make deploy NODE={{ inventory_hostname | regex_replace('node', '') }}                                             ║
          ║                                                                  ║
          ╚══════════════════════════════════════════════════════════════════╝
      tags: [upgrade]
