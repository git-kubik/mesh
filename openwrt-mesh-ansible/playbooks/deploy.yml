---
# Main playbook to deploy OpenWrt mesh network configuration
#
# This playbook performs a complete deployment including:
#  - SSH Server Transition: Dropbear (factory) → OpenSSH (production)
#  - Root password configuration
#  - Network configuration (batman-adv mesh)
#  - Wireless configuration (mesh + AP)
#  - DHCP and firewall setup
#  - USB storage setup (optional)
#
# Initial Setup Usage (fresh nodes at 192.168.1.1 with dropbear):
#   ansible-playbook -i inventory/hosts-initial.yml playbooks/deploy.yml --limit node1
#
# Production Usage (configured nodes at 10.11.12.x with openssh):
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml
#
# To deploy to specific node:
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --limit node1
#
# Check mode (dry run):
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --check

- name: Deploy OpenWrt Mesh Network Configuration
  hosts: mesh_nodes
  gather_facts: false

  pre_tasks:
    - name: Debug OPKG_REPO_URL environment variable
      ansible.builtin.debug:
        msg: "OPKG_REPO_URL = '{{ lookup('env', 'OPKG_REPO_URL') }}'"
      delegate_to: localhost
      run_once: true
      tags: always

    - name: Start local repository web server
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          # Stop any existing server on port 8080
          lsof -ti:8080 | xargs -r kill 2>/dev/null || true
          sleep 1

          # Start new server
          cd {{ playbook_dir }}/..
          nohup python3 -m http.server 8080 --directory openwrt-repo > /tmp/repo-server.log 2>&1 &
          echo $! > /tmp/repo-server.pid
          sleep 2
        executable: /bin/bash
      delegate_to: localhost
      run_once: true
      when: lookup('env', 'OPKG_REPO_URL') != ''
      changed_when: true
      tags: always

    - name: Wait for SSH to be available (no Python required)
      ansible.builtin.raw: echo "SSH connection successful"
      register: ssh_test
      retries: 30
      delay: 10
      until: ssh_test is success
      changed_when: false
      tags: always

    - name: Test connection and gather facts
      ansible.builtin.raw: uname -a
      register: uname_output
      changed_when: false
      tags: always

    - name: Display node information
      ansible.builtin.debug:
        msg: "Configuring {{ inventory_hostname }} at {{ ansible_host }}"
      tags: always

    - name: Load all environment variables as facts
      ansible.builtin.include_tasks: ../roles/common/tasks/load_env_vars.yml
      tags: always

  roles:
    - role: backup
      tags: [backup]

    - role: package_management
      tags: [packages]

    - role: ssh_transition
      tags: [ssh]

    - role: system_config
      tags: [system, security]

    - role: network_config
      tags: [config, network]

    - role: wireless_config
      tags: [config, wireless]

    - role: dhcp_config
      tags: [config, dhcp]

    - role: firewall_config
      tags: [config, firewall]

    - role: usb_storage
      tags: [usb, storage]
      when: lookup('env', 'ENABLE_USB_STORAGE') | default('true', true) | bool

    - role: monitoring
      tags: [monitoring]
      when: lookup('env', 'ENABLE_MONITORING') | default('true', true) | bool

  tasks:
    ###########################################################################
    # IMPORTANT: Configuration files deployed but NOT applied yet
    # Reboot will cleanly apply all configs at once
    # This prevents connection loss from network reload
    ###########################################################################

    - name: Display configuration deployment status
      ansible.builtin.debug:
        msg: |
          ✅ All configurations deployed (but not yet applied):
          - Network config → /etc/config/network
          - Wireless config → /etc/config/wireless
          - DHCP config → /etc/config/dhcp
          - Firewall config → /etc/config/firewall
          {% if usb_device_detected | default(false) %}
          - USB Storage → {{ usb_device_path | default('N/A') }} mounted at /x00
          - Monitoring → collectd, vnStat, health checks on /x00
          {% else %}
          - USB Storage → No device detected (skipped)
          - Monitoring → Skipped (requires USB storage)
          {% endif %}

          ⚠️  Reboot will apply all configurations
          ⚠️  Node IP will change: 192.168.1.1 → {{ node_ip }}
      tags: config

    ###########################################################################
    # Restore original opkg repository configuration
    # This ensures the node uses official OpenWrt repos after deployment
    ###########################################################################

    - name: Restore original opkg repository configuration
      ansible.builtin.raw: |
        if [ -f /etc/opkg/distfeeds.conf.orig ]; then
          cp /etc/opkg/distfeeds.conf.orig /etc/opkg/distfeeds.conf
          rm -f /etc/opkg/distfeeds.conf.orig
          echo "Restored original opkg repository configuration"
        else
          echo "No backup found - opkg configuration unchanged"
        fi
      changed_when: true
      tags: [packages, config]

    ###########################################################################
    # FINAL STEP: Reboot to apply all configurations
    # NOTE: Network reload is SKIPPED to prevent connection loss
    # Reboot will cleanly apply all network/wireless/DHCP/firewall configs
    ###########################################################################

    - name: Display pre-reboot warning
      ansible.builtin.debug:
        msg: |
          ⚠️  FINAL STEP: Rebooting node to apply all configurations
          ⚠️  Node IP will change: 192.168.1.1 → {{ node_ip }}
          ⚠️  After reboot, you must change your workstation network settings
      tags: always

    ###########################################################################
    # REQUIRED: Reboot node to apply all configurations
    # This is MANDATORY for initial deployment (IP change from 192.168.1.1)
    # Can be skipped for production redeployments with SKIP_REBOOT=true
    ###########################################################################

    - name: Reboot node to apply all configurations
      ansible.builtin.shell: "(sleep 2 && reboot) & sleep 1"
      register: reboot_result
      ignore_errors: true
      ignore_unreachable: true
      when:
        - not skip_reboot
        - not ansible_check_mode
      changed_when: true
      tags:
        - reboot

    - name: Display post-reboot instructions
      ansible.builtin.debug:
        msg: |
          ⚠️  NODE REBOOTING NOW

          REQUIRED NEXT STEPS:
          1. Wait ~60 seconds for node to reboot
          2. Change your workstation network to: 10.11.12.0/24
          3. Set static IP: 10.11.12.50 (or use DHCP from node)
          4. Verify connectivity: ping {{ node_ip }}
          5. Connect via SSH: ssh -i {{ ssh_key_path }} root@{{ node_ip }}
          6. Check mesh status: batctl o
      when:
        - not skip_reboot
        - not ansible_check_mode
      tags:
        - reboot

    - name: Configuration deployment complete
      ansible.builtin.debug:
        msg: |
          ✅ Configuration deployed to {{ inventory_hostname }}

          Node configuration:
          - IP Address: {{ node_ip }}
          - DHCP Pool: 10.11.12.{{ dhcp_pools[inventory_hostname].start }}-{{ dhcp_pools[inventory_hostname].start + dhcp_pools[inventory_hostname].limit - 1 }}
          - SSH: OpenSSH with key authentication
          - SSH Key: {{ ssh_key_path }}
          {% if usb_device_detected | default(false) %}
          - USB Storage: {{ usb_device_path | default('N/A') }} configured at /x00 (F2FS)
          {% else %}
          - USB Storage: Not configured (no device detected)
          {% endif %}

          ✅ Deployment complete - node will reboot to apply changes

          After node reboots and you change workstation network:
          - Run: make check-node1 (or check-node2, check-node3)
          - Or run: ansible-playbook -i inventory/hosts.yml playbooks/check-connectivity.yml --limit node1
      tags: always

  post_tasks:
    - name: Stop local repository web server
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          if [ -f /tmp/repo-server.pid ]; then
            kill $(cat /tmp/repo-server.pid) 2>/dev/null || true
            rm -f /tmp/repo-server.pid
          fi
          lsof -ti:8080 | xargs -r kill 2>/dev/null || true
        executable: /bin/bash
      delegate_to: localhost
      run_once: true
      when: lookup('env', 'OPKG_REPO_URL') != ''
      changed_when: true
      tags: always

  handlers:
    - name: Import centralized handlers
      ansible.builtin.import_tasks: ../handlers/main.yml
