---
# Vulnerability Scanning Playbook using Kali Linux Container
#
# Performs automated security vulnerability testing on mesh nodes
# using the kali-wifi Docker container with professional security tools.
#
# Run: ansible-playbook playbooks/vulnerability_scan.yml
#
# Requirements:
# - kali-wifi container running (docker compose up -d kali-wifi)
# - Network connectivity from Kali container to mesh nodes

- name: Vulnerability Scan via Kali Container
  hosts: localhost
  gather_facts: true
  vars:
    kali_container: "kali-wifi"
    scan_targets:
      - { name: "node1", mgmt_ip: "10.11.10.1", client_ip: "10.11.12.1" }
      - { name: "node2", mgmt_ip: "10.11.10.2", client_ip: "10.11.12.2" }
      - { name: "node3", mgmt_ip: "10.11.10.3", client_ip: "10.11.12.3" }
    report_dir: "/home/m/repos/mesh/vuln-reports"
    scan_ports: "22,53,80,443"
    nmap_timeout: 300

  tasks:
    - name: Create report directory
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    - name: Verify Kali container is running
      ansible.builtin.command:
        cmd: docker ps --filter name={{ kali_container }} --format '{{ '{{' }}.Names{{ '}}' }}'
      register: kali_status
      changed_when: false
      failed_when: kali_container not in kali_status.stdout

    - name: Display scan start
      ansible.builtin.debug:
        msg: |
          ============================================================
          VULNERABILITY SCAN STARTING
          ============================================================
          Container: {{ kali_container }}
          Targets: {{ scan_targets | map(attribute='name') | list | join(', ') }}
          Ports: {{ scan_ports }}
          Time: {{ ansible_date_time.iso8601 }}
          ============================================================

    # =========================================================================
    # CONNECTIVITY TEST
    # =========================================================================
    - name: "Connectivity - Test reachability from Kali"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }} nmap -sn {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: connectivity_test
      changed_when: false
      ignore_errors: true

    # =========================================================================
    # PORT SCANNING
    # =========================================================================
    - name: "Port Scan - Full TCP scan (management VLAN)"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn -sS --top-ports 1000 -T4 {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: port_scan
      changed_when: false
      timeout: "{{ nmap_timeout }}"

    # =========================================================================
    # SERVICE & VERSION DETECTION
    # =========================================================================
    - name: "Service Scan - Version detection"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn -sV -sC -p {{ scan_ports }} {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: service_scan
      changed_when: false
      timeout: "{{ nmap_timeout }}"

    # =========================================================================
    # VULNERABILITY SCANNING
    # =========================================================================
    - name: "Vuln Scan - NSE vulnerability scripts"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn --script vuln -p {{ scan_ports }} {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: vuln_scan
      changed_when: false
      timeout: 600

    # =========================================================================
    # SSL/TLS ANALYSIS
    # =========================================================================
    - name: "TLS Scan - Cipher enumeration"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn --script ssl-enum-ciphers -p 443 {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: tls_scan
      changed_when: false
      timeout: 120

    - name: "TLS Scan - SSL vulnerabilities"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn --script ssl-heartbleed,ssl-poodle,ssl-ccs-injection -p 443 {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: ssl_vuln_scan
      changed_when: false
      timeout: 120

    # =========================================================================
    # SSH SECURITY
    # =========================================================================
    - name: "SSH Scan - Authentication methods"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn --script ssh-auth-methods,ssh2-enum-algos -p 22 {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: ssh_scan
      changed_when: false
      timeout: 120

    # =========================================================================
    # HTTP SECURITY
    # =========================================================================
    - name: "HTTP Scan - Nikto web vulnerability scan"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nikto -h https://{{ item.mgmt_ip }} -ssl -Tuning 123bde -timeout 10 -nointeractive
      loop: "{{ scan_targets }}"
      register: nikto_scan
      changed_when: false
      timeout: 300
      ignore_errors: true

    - name: "HTTP Scan - Security headers check"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn --script http-security-headers -p 80,443 {{ item.mgmt_ip }}
      loop: "{{ scan_targets }}"
      register: http_headers_scan
      changed_when: false
      timeout: 60

    # =========================================================================
    # FIREWALL ZONE ISOLATION TEST
    # =========================================================================
    - name: "Firewall Test - Client VLAN isolation"
      ansible.builtin.command:
        cmd: >
          docker exec {{ kali_container }}
          nmap -Pn -p {{ scan_ports }} {{ item.client_ip }}
      loop: "{{ scan_targets }}"
      register: firewall_test
      changed_when: false
      timeout: 60
      ignore_errors: true

    # =========================================================================
    # GENERATE REPORTS
    # =========================================================================
    - name: Set report timestamp
      ansible.builtin.set_fact:
        report_timestamp: "{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}"

    - name: Generate JSON report
      ansible.builtin.copy:
        content: |
          {
            "metadata": {
              "timestamp": "{{ ansible_date_time.iso8601 }}",
              "scanner": "kali-wifi container",
              "targets": {{ scan_targets | to_json }},
              "ports": "{{ scan_ports }}"
            },
            "port_scan": [
              {% for r in port_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "service_scan": [
              {% for r in service_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "vuln_scan": [
              {% for r in vuln_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "tls_scan": [
              {% for r in tls_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "ssh_scan": [
              {% for r in ssh_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "nikto_scan": [
              {% for r in nikto_scan.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | default('scan failed') | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            "firewall_isolation": [
              {% for r in firewall_test.results %}
              {"node": "{{ r.item.name }}", "output": {{ r.stdout | default('test failed') | to_json }}}{% if not loop.last %},{% endif %}
              {% endfor %}
            ]
          }
        dest: "{{ report_dir }}/vuln-scan-{{ report_timestamp }}.json"
        mode: '0644'

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Analyze results
      ansible.builtin.set_fact:
        scan_summary:
          tls_grade: "{{ 'A' if tls_scan.results | map(attribute='stdout') | join(' ') | regex_search('least strength: A') else 'Review' }}"
          ssh_secure: "{{ 'Yes' if 'publickey' in ssh_scan.results | map(attribute='stdout') | join(' ') and 'password' not in ssh_scan.results | map(attribute='stdout') | join(' ') else 'No' }}"
          firewall_ok: "{{ 'Yes' if 'filtered' in firewall_test.results | map(attribute='stdout', default='') | join(' ') else 'Review' }}"

    - name: Display scan summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          VULNERABILITY SCAN COMPLETE
          ============================================================

          QUICK RESULTS:
            TLS Security:     {{ scan_summary.tls_grade }}
            SSH Key-Only:     {{ scan_summary.ssh_secure }}
            Firewall Zones:   {{ scan_summary.firewall_ok }}

          OPEN PORTS (Management VLAN):
          {% for r in port_scan.results %}
            {{ r.item.name }}: {{ r.stdout | regex_findall('\\d+/tcp\\s+open\\s+\\w+') | join(', ') | default('none detected') }}
          {% endfor %}

          TLS CIPHERS:
          {% for r in tls_scan.results %}
            {{ r.item.name }}: {{ 'Grade A - Strong ciphers' if 'least strength: A' in r.stdout else 'Review needed' }}
          {% endfor %}

          SSH SECURITY:
          {% for r in ssh_scan.results %}
            {{ r.item.name }}: {{ 'publickey only' if 'publickey' in r.stdout and 'password' not in r.stdout else 'REVIEW NEEDED' }}
          {% endfor %}

          FIREWALL ISOLATION (Client VLAN -> Management):
          {% for r in firewall_test.results %}
            {{ r.item.name }}: {{ 'FILTERED (good)' if 'filtered' in r.stdout | default('') else 'OPEN (review)' }}
          {% endfor %}

          NIKTO WEB SCAN:
          {% for r in nikto_scan.results %}
            {{ r.item.name }}: {{ (r.stdout | default('') | regex_findall('\\+ .*') | length) | string + ' findings' if r.stdout is defined else 'scan failed' }}
          {% endfor %}

          VULNERABILITY FINDINGS:
          {% for r in vuln_scan.results %}
            {{ r.item.name }}: {{ 'VULNERABLE' if 'VULNERABLE' in r.stdout else 'No critical vulns' }}
          {% endfor %}

          ============================================================
          Full report: {{ report_dir }}/vuln-scan-{{ report_timestamp }}.json
          ============================================================
