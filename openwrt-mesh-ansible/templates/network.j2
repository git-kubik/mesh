# Network configuration for {{ inventory_hostname }}
# Generated by Ansible - DO NOT EDIT MANUALLY

config interface 'loopback'
	option device 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix 'fd12:3456:789a::/48'

# WAN Interface
config interface 'wan'
	option device 'wan'
	option proto 'dhcp'
	option peerdns '0'
{% for dns in dns_servers %}
	list dns '{{ dns }}'
{% endfor %}

config interface 'wan6'
	option device 'wan'
	option proto 'dhcpv6'

# Batman-adv Main Interface
config interface 'bat0'
	option proto 'batadv'
	option routing_algo '{{ batman_routing_algo }}'
	option gw_mode 'server'
	option gw_bandwidth '{{ batman_gw_bandwidth }}'
	option distributed_arp_table '1'
	option bridge_loop_avoidance '1'
	option multicast_mode '1'
	option fragmentation '1'
	option hop_penalty '{{ batman_hop_penalty }}'
	option orig_interval '{{ batman_orig_interval }}'

# Wired mesh interface - lan3
config interface 'bat0_hardif_lan3'
	option proto 'batadv_hardif'
	option master 'bat0'
	option mtu '{{ mtu_wired_mesh }}'

# Wired mesh interface - lan4
config interface 'bat0_hardif_lan4'
	option proto 'batadv_hardif'
	option master 'bat0'
	option mtu '{{ mtu_wired_mesh }}'

# Wireless mesh interface - 2.4GHz backup
config interface 'bat0_hardif_mesh0'
	option proto 'batadv_hardif'
	option master 'bat0'
	option mtu '{{ mtu_wireless_mesh }}'

# Physical device for mesh ports
config device 'lan3'
	option name 'lan3'
	option mtu '{{ mtu_wired_mesh }}'

config device 'lan4'
	option name 'lan4'
	option mtu '{{ mtu_wired_mesh }}'

# LAN Bridge
config device 'br_lan'
	option name 'br-lan'
	option type 'bridge'
	list ports 'bat0'
	list ports 'lan1'
	list ports 'lan2'
	# Note: lan3 and lan4 NOT in bridge - dedicated to mesh

config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '{{ node_ip }}'
	option netmask '{{ mesh_netmask }}'
	option ip6assign '60'
{% if not dhcp_server %}
	option gateway '{{ mesh_gateway }}'
	list dns '{{ mesh_gateway }}'
{% endif %}

{% if enable_vlans %}
# VLAN Configurations
{% for vlan_name, vlan_config in vlans.items() %}

config interface '{{ vlan_name }}'
	option proto 'batadv_vlan'
	option master 'bat0'
	option vid '{{ vlan_config.vid }}'
{% if vlan_config.isolation is defined and vlan_config.isolation %}
	option ap_isolation '1'
{% else %}
	option ap_isolation '0'
{% endif %}

config interface '{{ vlan_name }}_bridge'
	option proto 'static'
	option type 'bridge'
	list ports '{{ vlan_name }}'
	option ipaddr '{{ vlan_config.network | ipaddr('1') | ipaddr('address') }}'
	option netmask '{{ vlan_config.network | ipaddr('netmask') }}'
{% endfor %}
{% endif %}
