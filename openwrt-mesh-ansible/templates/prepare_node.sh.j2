#!/bin/sh
###############################################################################
# OpenWrt Mesh Node Preparation Script
# Generated by Ansible audit playbook
###############################################################################
#
# Node: {{ inventory_hostname }}
# Generated: {{ audit_timestamp }}
# Hardware: {{ system_id.stdout_lines[1] | default('Unknown Model') }}
# OpenWrt: {{ system_id.stdout_lines[6] | default('Unknown Version') | regex_replace('.*DISTRIB_RELEASE=', '') | regex_replace("'", '') }}
#
# Purpose: Prepare this node for automated mesh network deployment
#
# Usage:
#   1. Copy to node: scp {{ inventory_hostname }}_prepare.sh root@{{ ansible_host }}:/tmp/
#   2. Execute: ssh root@{{ ansible_host }} 'sh /tmp/{{ inventory_hostname }}_prepare.sh'
#   3. Re-run audit to verify readiness
#
###############################################################################

set -e  # Exit on error
set -u  # Exit on undefined variable

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo "${RED}[ERROR]${NC} $1"
}

# Banner
echo "================================================================================"
echo "OpenWrt Mesh Node Preparation Script"
echo "================================================================================"
echo "Node: {{ inventory_hostname }}"
echo "Hardware: {{ system_id.stdout_lines[1] | default('Unknown Model') }}"
echo "OpenWrt: {{ system_id.stdout_lines[6] | default('Unknown Version') | regex_replace('.*DISTRIB_RELEASE=', '') | regex_replace("'", '') }}"
echo "Generated: {{ audit_timestamp }}"
echo "================================================================================"
echo ""

###############################################################################
# Phase 1: Pre-flight Checks
###############################################################################

log_info "Running pre-flight checks..."

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    log_error "This script must be run as root"
    exit 1
fi

# Check internet connectivity
if ! ping -c 1 -W 5 1.1.1.1 >/dev/null 2>&1; then
    log_warning "No internet connectivity detected - opkg update may fail"
    log_warning "Ensure WAN interface is configured and connected"
fi

# Check available storage
AVAILABLE_KB=$(df / | tail -1 | awk '{print $4}')
if [ "$AVAILABLE_KB" -lt 5120 ]; then  # Less than 5MB
    log_warning "Low storage space: ${AVAILABLE_KB}KB available"
    log_warning "Consider removing unnecessary packages first"
fi

log_success "Pre-flight checks completed"
echo ""

###############################################################################
# Phase 2: Backup Current Configuration
###############################################################################

log_info "Creating backup of current configuration..."

BACKUP_FILE="/tmp/backup-before-prep-$(date +%Y%m%d-%H%M%S).tar.gz"
if sysupgrade -b "$BACKUP_FILE" 2>/dev/null; then
    log_success "Backup created: $BACKUP_FILE"
    log_info "Download this file before proceeding with deployment"
else
    log_warning "Backup creation failed - proceeding anyway"
fi

echo ""

###############################################################################
# Phase 3: Update Package Lists
###############################################################################

log_info "Updating package lists from repositories..."

if opkg update; then
    log_success "Package lists updated successfully"
else
    log_error "Failed to update package lists"
    log_error "Check your internet connection and DNS settings"
    exit 1
fi

echo ""

###############################################################################
# Phase 4: Remove Conflicting Packages
###############################################################################

{% if package_audit.conflicting | length > 0 %}
log_info "Removing conflicting packages..."

CONFLICTS="{{ package_audit.conflicting | join(' ') }}"
CONFLICT_COUNT={{ package_audit.conflicting | length }}

echo "Packages to remove ($CONFLICT_COUNT):"
{% for pkg in package_audit.conflicting %}
echo "  - {{ pkg }}"
{% endfor %}
echo ""

{% for pkg in package_audit.conflicting %}
log_info "Removing {{ pkg }}..."
if opkg remove {{ pkg }}; then
    log_success "Removed {{ pkg }}"
else
    log_warning "Failed to remove {{ pkg }} - may not be installed"
fi
{% endfor %}

log_success "Conflicting packages removed"
echo ""

{% else %}
log_info "No conflicting packages detected - skipping removal phase"
echo ""
{% endif %}

###############################################################################
# Phase 5: Install Required Packages
###############################################################################

{% if package_audit.missing_required | length > 0 %}
log_info "Installing required packages..."

REQUIRED="{{ package_audit.missing_required | join(' ') }}"
REQUIRED_COUNT={{ package_audit.missing_required | length }}

echo "Packages to install ($REQUIRED_COUNT):"
{% for pkg in package_audit.missing_required %}
echo "  - {{ pkg }}"
{% endfor %}
echo ""

log_info "Installing all required packages..."
if opkg install $REQUIRED; then
    log_success "All required packages installed successfully"
else
    log_error "Failed to install some packages"
    log_error "Manual investigation required"
    exit 1
fi

echo ""

{% else %}
log_info "All required packages already installed - skipping installation phase"
echo ""
{% endif %}

###############################################################################
# Phase 6: Install Optional Packages (Best Effort)
###############################################################################

{% if optional_packages is defined and optional_packages | length > 0 %}
log_info "Installing optional packages (best effort)..."

{% for pkg in optional_packages %}
{% if pkg not in package_audit.installed_optional %}
log_info "Installing {{ pkg }}..."
if opkg install {{ pkg }}; then
    log_success "Installed {{ pkg }}"
else
    log_warning "Failed to install {{ pkg }} - continuing anyway"
fi
{% endif %}
{% endfor %}

echo ""
{% endif %}

###############################################################################
# Phase 7: Verification
###############################################################################

log_info "Verifying installation..."

# Check for required packages
MISSING_COUNT=0
{% for pkg in required_packages %}
if ! opkg list-installed | grep -q "^{{ pkg }} "; then
    log_error "Required package missing: {{ pkg }}"
    MISSING_COUNT=$((MISSING_COUNT + 1))
fi
{% endfor %}

if [ "$MISSING_COUNT" -eq 0 ]; then
    log_success "All required packages verified"
else
    log_error "$MISSING_COUNT required packages still missing"
    exit 1
fi

# Check for conflicting packages
CONFLICT_COUNT=0
{% for pkg in remove_packages %}
if opkg list-installed | grep -q "^{{ pkg }} "; then
    log_warning "Conflicting package still installed: {{ pkg }}"
    CONFLICT_COUNT=$((CONFLICT_COUNT + 1))
fi
{% endfor %}

if [ "$CONFLICT_COUNT" -eq 0 ]; then
    log_success "No conflicting packages detected"
else
    log_warning "$CONFLICT_COUNT conflicting packages still present"
fi

echo ""

###############################################################################
# Phase 8: Summary & Next Steps
###############################################################################

echo "================================================================================"
echo "PREPARATION COMPLETE"
echo "================================================================================"
log_success "Node {{ inventory_hostname }} is ready for Ansible deployment"
echo ""
echo "Summary:"
echo "  - Backup created: $BACKUP_FILE"
{% if package_audit.conflicting | length > 0 %}
echo "  - Removed {{ package_audit.conflicting | length }} conflicting package(s)"
{% endif %}
{% if package_audit.missing_required | length > 0 %}
echo "  - Installed {{ package_audit.missing_required | length }} required package(s)"
{% endif %}
echo "  - All required packages verified"
echo ""
echo "Next Steps:"
echo "  1. Download backup file from node:"
echo "     scp root@{{ ansible_host }}:$BACKUP_FILE ./backups/"
echo ""
echo "  2. Re-run audit playbook to verify readiness:"
echo "     ansible-playbook -i inventory/hosts.yml playbooks/audit.yml -l {{ inventory_hostname }}"
echo ""
echo "  3. If audit passes, proceed with full deployment:"
echo "     ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml -l {{ inventory_hostname }}"
echo ""
echo "================================================================================"

exit 0
